<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sambuwig POS System | Enterprise Edition</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Custom Styles -->
    <style>
        /* SCROLLBAR CUSTOMIZATION */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ANIMATIONS */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .slide-in { animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .pulse-alert { animation: pulseRed 2s infinite; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulseRed { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* COMPONENT STYLES */
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .category-btn.active { background-color: #ea580c; color: white; border-color: #ea580c; transform: scale(1.05); }
        
        /* KITCHEN CHECKBOX */
        .kitchen-checkbox { appearance: none; width: 24px; height: 24px; border: 2px solid #cbd5e1; border-radius: 6px; cursor: pointer; transition: all 0.2s; position: relative; }
        .kitchen-checkbox:checked { background-color: #22c55e; border-color: #22c55e; }
        .kitchen-checkbox:checked::after { content: '✔'; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; font-weight: bold; }
        .item-cooked { text-decoration: line-through; color: #94a3b8; opacity: 0.7; }

        /* POS CARD */
        .pos-card { transition: all 0.2s; }
        .pos-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .pos-card:active { transform: scale(0.98); }

        /* PRINT STYLES */
        @media print {
            @page { margin: 0; size: 80mm auto; } /* Thermal Paper size usually 80mm */
            body * { visibility: hidden; }
            #receipt-print-area, #receipt-print-area * { visibility: visible; }
            #receipt-print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; background: white; color: black; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans h-screen overflow-hidden flex flex-col">

    <!-- ================================================================================== -->
    <!--                                  NOTIFICATIONS & MODALS                             -->
    <!-- ================================================================================== -->

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="fixed top-6 right-6 z-[100] transform translate-x-full transition-all duration-500 ease-in-out">
        <div class="bg-white border-l-8 border-blue-600 shadow-2xl rounded-r-lg p-4 flex items-center min-w-[300px]">
            <div id="toast-icon" class="mr-4 text-2xl text-blue-600"><i class="fas fa-info-circle"></i></div>
            <div>
                <h4 id="toast-title" class="font-bold text-slate-800 text-sm uppercase tracking-wider">Notification</h4>
                <p id="toast-message" class="text-sm text-slate-600 mt-1 font-medium">Message content</p>
            </div>
        </div>
    </div>

    <!-- LOADING SPINNER OVERLAY -->
    <div id="global-loader" class="fixed inset-0 bg-black/50 z-[200] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-xl flex flex-col items-center animate-bounce">
            <i class="fas fa-utensils text-4xl text-orange-600 mb-2"></i>
            <span class="font-bold text-slate-700">Processing...</span>
        </div>
    </div>

    <!-- MODAL: DISCOUNT MANAGER -->
    <div id="modal-discount" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-purple-700 p-4 text-white flex justify-between items-center">
                <h3 class="text-lg font-bold"><i class="fas fa-tags mr-2"></i> Apply Discount</h3>
                <button onclick="closeModal('modal-discount')" class="hover:bg-purple-600 p-2 rounded-full transition"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scrollbar">
                <!-- Step 1: Item Selection -->
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">1. Select Items to Discount</label>
                    <div class="flex justify-between mb-2">
                        <button onclick="toggleAllDiscountItems(true)" class="text-xs text-blue-600 font-bold hover:underline">Select All</button>
                        <button onclick="toggleAllDiscountItems(false)" class="text-xs text-slate-500 hover:underline">Deselect All</button>
                    </div>
                    <div id="discount-item-list" class="border rounded-lg max-h-48 overflow-y-auto p-2 bg-slate-50 space-y-1">
                        <!-- Dynamic Checkboxes -->
                    </div>
                </div>

                <!-- Step 2: Discount Type -->
                <div class="mb-6">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">2. Select Discount Type</label>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setDiscountType('custom')" id="btn-disc-custom" class="disc-type-btn p-3 border rounded-xl text-center hover:bg-slate-50 focus:ring-2 ring-purple-500 transition">
                            <i class="fas fa-percent text-xl mb-1 text-blue-500"></i><br><span class="text-xs font-bold">Manual</span>
                        </button>
                        <button onclick="setDiscountType('pwd_senior')" id="btn-disc-senior" class="disc-type-btn p-3 border rounded-xl text-center hover:bg-slate-50 focus:ring-2 ring-purple-500 transition">
                            <i class="fas fa-wheelchair text-xl mb-1 text-green-500"></i><br><span class="text-xs font-bold">PWD/Senior</span>
                        </button>
                        <button onclick="setDiscountType('employee')" id="btn-disc-emp" class="disc-type-btn p-3 border rounded-xl text-center hover:bg-slate-50 focus:ring-2 ring-purple-500 transition">
                            <i class="fas fa-id-badge text-xl mb-1 text-orange-500"></i><br><span class="text-xs font-bold">Employee</span>
                        </button>
                    </div>
                    <input type="hidden" id="selected-discount-type" value="custom">
                </div>

                <!-- Step 3: Dynamic Inputs -->
                <div id="disc-inputs-container" class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <!-- Custom -->
                    <div id="input-custom" class="disc-input-group">
                        <label class="block text-xs font-bold text-slate-600 mb-1">Percentage (%)</label>
                        <input type="number" id="disc-percent" class="w-full border-slate-300 rounded-lg p-2.5 focus:ring-purple-500 focus:border-purple-500" placeholder="Enter percentage (e.g., 10)">
                    </div>
                    <!-- PWD/Senior -->
                    <div id="input-senior" class="disc-input-group hidden">
                        <div class="flex items-center mb-2 text-green-700 bg-green-100 p-2 rounded text-xs font-bold"><i class="fas fa-check-circle mr-2"></i> Fixed 20% Discount</div>
                        <label class="block text-xs font-bold text-slate-600 mb-1">Customer ID Number (Required)</label>
                        <input type="text" id="disc-id-num" class="w-full border-slate-300 rounded-lg p-2.5 focus:ring-purple-500 focus:border-purple-500" placeholder="ID Number">
                    </div>
                    <!-- Employee -->
                    <div id="input-employee" class="disc-input-group hidden">
                        <div class="flex items-center mb-2 text-orange-700 bg-orange-100 p-2 rounded text-xs font-bold"><i class="fas fa-check-circle mr-2"></i> Fixed 10% Discount</div>
                        <label class="block text-xs font-bold text-slate-600 mb-1">Employee Verification</label>
                        <div class="grid grid-cols-1 gap-3">
                            <input type="text" id="disc-emp-user" class="w-full border-slate-300 rounded-lg p-2.5" placeholder="Employee Account/ID">
                            <input type="password" id="disc-emp-pass" class="w-full border-slate-300 rounded-lg p-2.5" placeholder="Password">
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-4 bg-slate-100 border-t flex justify-end gap-3">
                <button onclick="closeModal('modal-discount')" class="px-5 py-2.5 bg-white border border-slate-300 rounded-lg text-slate-700 font-bold hover:bg-slate-50 transition">Cancel</button>
                <button onclick="applyDiscountConfirm()" class="px-5 py-2.5 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 shadow-lg transition flex items-center"><i class="fas fa-check mr-2"></i> Apply Discount</button>
            </div>
        </div>
    </div>

    <!-- MODAL: PAYABLE (FUTURE PAYMENT) -->
    <div id="modal-payable" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4 fade-in">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden">
            <div class="bg-orange-600 p-4 text-white text-center">
                <i class="fas fa-clock text-4xl mb-2 text-orange-200"></i>
                <h3 class="text-xl font-bold">Charge to Account</h3>
                <p class="text-orange-100 text-xs">Payable later (Max 3 days)</p>
            </div>
            <div class="p-6">
                <p class="text-xs text-slate-500 mb-4 text-center">Please enter the SMBWG Authorized Account credentials to charge this order.</p>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Account Name</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="fas fa-user"></i></span>
                            <input type="text" id="pay-user" class="w-full pl-10 border-slate-300 rounded-lg p-2.5 focus:ring-orange-500" placeholder="e.g., smbwg">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-1">Secure Password</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-slate-400"><i class="fas fa-lock"></i></span>
                            <input type="password" id="pay-pass" class="w-full pl-10 border-slate-300 rounded-lg p-2.5 focus:ring-orange-500">
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-between gap-3">
                <button onclick="closeModal('modal-payable')" class="w-1/2 px-4 py-2 bg-white border border-slate-300 rounded-lg font-bold text-slate-600">Cancel</button>
                <button onclick="confirmPayable()" class="w-1/2 px-4 py-2 bg-orange-600 text-white rounded-lg font-bold hover:bg-orange-700 shadow">Confirm</button>
            </div>
        </div>
    </div>

    <!-- MODAL: EDIT INVENTORY -->
    <div id="modal-edit-item" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden">
            <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
                <h3 class="font-bold"><i class="fas fa-edit mr-2"></i> Edit Inventory Item</h3>
                <button onclick="closeModal('modal-edit-item')"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-item-id">
                <div>
                    <label class="block text-xs font-bold text-slate-600 mb-1">Item Name</label>
                    <input type="text" id="edit-item-name" class="w-full border-slate-300 rounded p-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1">Price (₱)</label>
                        <input type="number" step="0.01" id="edit-item-price" class="w-full border-slate-300 rounded p-2">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-600 mb-1">Stock Level</label>
                        <input type="number" id="edit-item-stock" class="w-full border-slate-300 rounded p-2">
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-2">
                <button onclick="saveItemEdit()" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 shadow">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ADMIN TRANSACTION EDITOR -->
    <div id="modal-edit-trans" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4 fade-in">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden border-t-4 border-red-600">
            <div class="p-6">
                <h3 class="text-xl font-bold text-red-700 mb-1">Admin Correction</h3>
                <p class="text-xs text-slate-500 mb-4">Manually adjust transaction totals. This action will be logged.</p>
                <input type="hidden" id="edit-trans-id">
                <label class="block text-xs font-bold text-slate-700 mb-1">New Total Amount (₱)</label>
                <input type="number" step="0.01" id="edit-trans-total" class="w-full border-2 border-red-100 rounded-lg p-3 text-lg font-mono font-bold text-red-600 focus:border-red-500 focus:ring-red-500">
            </div>
            <div class="p-4 bg-slate-50 border-t flex justify-end gap-2">
                <button onclick="closeModal('modal-edit-trans')" class="px-4 py-2 text-slate-500 hover:text-slate-800 font-bold">Cancel</button>
                <button onclick="saveTransEdit()" class="px-4 py-2 bg-red-600 text-white rounded font-bold hover:bg-red-700 shadow">Update Transaction</button>
            </div>
        </div>
    </div>

    <!-- RECEIPT TEMPLATE (Hidden Screen, Visible Print) -->
    <div id="receipt-print-area" class="hidden font-mono text-xs leading-tight text-black p-2">
        <div class="text-center mb-4">
            <h1 class="font-bold text-2xl uppercase tracking-widest mb-1">Sambuwig</h1>
            <p class="text-[10px] uppercase">Gourmet & Dining</p>
            <p>123 Food Street, Metro Manila</p>
            <p>Tel: (02) 8888-1234</p>
            <p class="mt-2 border-b border-black pb-2 border-dashed">VAT REG TIN: 000-123-456-789</p>
        </div>
        
        <div class="mb-2">
            <div class="flex justify-between"><span>Date:</span> <span id="receipt-date"></span></div>
            <div class="flex justify-between"><span>OR #:</span> <span id="receipt-id"></span></div>
            <div class="flex justify-between"><span>Table:</span> <span id="receipt-table" class="font-bold"></span></div>
            <div class="flex justify-between"><span>Cashier:</span> <span id="receipt-staff"></span></div>
        </div>

        <div id="receipt-details-extra" class="mb-2 border-t border-black border-dashed pt-1 hidden"></div>

        <table class="w-full mb-2 border-collapse">
            <thead>
                <tr class="border-b border-black text-left">
                    <th class="py-1">Item</th>
                    <th class="py-1 text-right">Qty</th>
                    <th class="py-1 text-right">Amount</th>
                </tr>
            </thead>
            <tbody id="receipt-items" class="border-b border-black">
                <!-- Items -->
            </tbody>
        </table>

        <div class="flex justify-between font-bold text-sm mt-2">
            <span>TOTAL DUE</span>
            <span id="receipt-total"></span>
        </div>
        
        <div class="text-center mt-6 text-[10px]">
            <p class="font-bold">THIS SERVES AS YOUR OFFICIAL RECEIPT</p>
            <p>Thank you for dining with us!</p>
            <p id="receipt-footer-msg" class="mt-2 font-bold italic"></p>
        </div>
    </div>

    <!-- ================================================================================== -->
    <!--                                  MAIN APPLICATION UI                                -->
    <!-- ================================================================================== -->

    <div id="app" class="flex-1 flex flex-col relative h-full">
        
        <!-- MOBILE HEADER -->
        <div class="md:hidden bg-slate-900 text-white p-4 flex justify-between items-center z-50 shadow-md">
            <div class="font-bold text-xl flex items-center">
                <span class="w-8 h-8 bg-orange-600 rounded-lg flex items-center justify-center mr-2"><i class="fas fa-utensils text-sm"></i></span>
                Sambuwig
            </div>
            <button id="mobile-menu-btn" class="focus:outline-none p-2 rounded hover:bg-slate-800"><i class="fas fa-bars text-xl"></i></button>
        </div>

        <!-- LOGIN SCREEN -->
        <div id="login-view" class="absolute inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full border-t-8 border-orange-600">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-600 text-3xl">
                        <i class="fas fa-utensils"></i>
                    </div>
                    <h1 class="text-3xl font-bold text-slate-800">Sambuwig POS</h1>
                    <p class="text-slate-500">Authorized Access Only</p>
                </div>
                <form id="login-form" class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Email Address</label>
                        <input type="email" id="email" class="w-full border-slate-300 rounded-lg p-3 focus:ring-orange-500 focus:border-orange-500 shadow-sm transition" placeholder="staff@sambuwig.com" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-700 uppercase mb-1">Password</label>
                        <input type="password" id="password" class="w-full border-slate-300 rounded-lg p-3 focus:ring-orange-500 focus:border-orange-500 shadow-sm transition" placeholder="••••••••" required>
                    </div>
                    <button type="submit" class="w-full bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 text-white font-bold py-3.5 rounded-lg shadow-lg transform hover:scale-[1.02] transition duration-200">
                        Secure Login <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </form>
                <div class="mt-6 text-center text-xs text-slate-400">
                    System Ver 2.6.0 | Enterprise Edition
                </div>
            </div>
        </div>

        <!-- MAIN WORKSPACE -->
        <div id="main-layout" class="hidden h-full flex flex-row relative overflow-hidden">
            
            <!-- OVERLAY FOR MOBILE -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden glass-panel"></div>

            <!-- SIDEBAR NAVIGATION -->
            <nav id="sidebar" class="bg-slate-900 text-slate-300 w-72 flex-shrink-0 flex flex-col justify-between absolute md:relative inset-y-0 left-0 transform -translate-x-full md:translate-x-0 z-40 transition-transform duration-300 shadow-2xl">
                <div class="flex flex-col h-full">
                    <!-- Brand -->
                    <div class="p-6 flex items-center justify-between font-bold text-2xl text-white border-b border-slate-800">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-orange-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg"><i class="fas fa-utensils text-white text-lg"></i></div>
                            <span>Sambuwig</span>
                        </div>
                        <button class="md:hidden text-slate-500 hover:text-white" id="close-sidebar"><i class="fas fa-times"></i></button>
                    </div>

                    <!-- Menu Items -->
                    <div class="flex-1 overflow-y-auto py-6 px-4 space-y-1 custom-scrollbar">
                        
                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-2 px-3">Main</div>
                        <button onclick="switchTab('dashboard')" class="nav-btn role-admin role-manager role-oversee group w-full text-left p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 data-[active=true]:bg-orange-600 data-[active=true]:text-white data-[active=true]:shadow-lg" data-target="dashboard">
                            <i class="fas fa-chart-pie w-8 text-center opacity-70 group-hover:opacity-100"></i> <span class="font-medium">Dashboard</span>
                        </button>

                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-6 px-3">Operations</div>
                        <button onclick="switchTab('pos')" class="nav-btn role-admin role-waiter role-manager group w-full text-left p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 data-[active=true]:bg-orange-600 data-[active=true]:text-white" data-target="pos">
                            <i class="fas fa-cash-register w-8 text-center opacity-70 group-hover:opacity-100"></i> <span class="font-medium">Point of Sale</span>
                        </button>
                        <button onclick="switchTab('kitchen')" class="nav-btn role-admin role-kitchen role-manager role-waiter role-oversee group w-full text-left p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 data-[active=true]:bg-orange-600 data-[active=true]:text-white" data-target="kitchen">
                            <div class="relative w-8 text-center">
                                <i class="fas fa-fire opacity-70 group-hover:opacity-100"></i>
                                <span id="kitchen-badge" class="absolute -top-2 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-slate-900 hidden">0</span>
                            </div>
                            <span class="font-medium">Kitchen Display</span>
                        </button>
                        <button onclick="switchTab('cashier')" class="nav-btn role-admin role-manager role-waiter group w-full text-left p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 data-[active=true]:bg-orange-600 data-[active=true]:text-white" data-target="cashier">
                            <div class="relative w-8 text-center">
                                <i class="fas fa-table opacity-70 group-hover:opacity-100"></i>
                                <span id="cashier-badge" class="absolute -top-2 -right-1 bg-blue-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full border-2 border-slate-900 hidden">0</span>
                            </div>
                            <span class="font-medium">Cashier & Tables</span>
                        </button>

                        <div class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 mt-6 px-3">Management</div>
                        <button onclick="switchTab('history')" class="nav-btn role-admin role-manager role-oversee group w-full text-left p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 data-[active=true]:bg-orange-600 data-[active=true]:text-white" data-target="history">
                            <i class="fas fa-history w-8 text-center opacity-70 group-hover:opacity-100"></i> <span class="font-medium">Transaction Logs</span>
                        </button>
                        <button onclick="switchTab('inventory')" class="nav-btn role-admin role-manager role-oversee group w-full text-left p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 data-[active=true]:bg-orange-600 data-[active=true]:text-white" data-target="inventory">
                            <i class="fas fa-boxes w-8 text-center opacity-70 group-hover:opacity-100"></i> <span class="font-medium">Inventory</span>
                        </button>
                        <button onclick="switchTab('settings')" class="nav-btn role-admin role-oversee role-waiter role-kitchen role-manager group w-full text-left p-3 rounded-lg hover:bg-slate-800 transition flex items-center text-slate-300 data-[active=true]:bg-orange-600 data-[active=true]:text-white" data-target="settings">
                            <i class="fas fa-cog w-8 text-center opacity-70 group-hover:opacity-100"></i> <span class="font-medium">Settings</span>
                        </button>
                    </div>

                    <!-- User Profile -->
                    <div class="p-4 bg-slate-950 border-t border-slate-800">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center text-slate-300 font-bold text-sm" id="user-avatar">U</div>
                            <div class="overflow-hidden">
                                <div id="user-role-display" class="text-[10px] uppercase font-bold text-orange-500 tracking-wider">Loading...</div>
                                <div id="user-email-display" class="text-xs text-white truncate w-32">user@email.com</div>
                            </div>
                        </div>
                        <button id="logout-btn" class="w-full bg-slate-800 hover:bg-red-600 hover:text-white text-slate-400 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </div>
            </nav>

            <!-- ======================= CONTENT AREA ======================= -->
            <main class="flex-1 overflow-y-auto relative bg-slate-100 w-full p-4 md:p-6 custom-scrollbar">
                
                <!-- 1. DASHBOARD -->
                <div id="tab-dashboard" class="content-tab space-y-6 fade-in max-w-7xl mx-auto">
                    <header class="flex justify-between items-end border-b pb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800">Dashboard</h2>
                            <p class="text-slate-500 text-sm">Real-time overview of restaurant performance.</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs font-bold text-slate-400 uppercase">Current Date</p>
                            <p class="text-lg font-bold text-slate-700" id="dash-date">---</p>
                        </div>
                    </header>
                    
                    <!-- Alerts Section -->
                    <div id="payable-alert" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded-r shadow-sm flex items-start pulse-alert">
                        <div class="text-red-500 mr-3 mt-1"><i class="fas fa-exclamation-triangle text-xl"></i></div>
                        <div>
                            <h4 class="font-bold text-red-800">Action Required: Overdue Payables</h4>
                            <p class="text-sm text-red-600">There are unpaid "Payable" orders older than 3 days. Please review the Cashier tab.</p>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Card 1 -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Total Sales Today</p>
                                    <h3 class="text-3xl font-bold text-slate-800 mt-1" id="total-sales">₱0.00</h3>
                                </div>
                                <div class="p-3 bg-green-100 text-green-600 rounded-xl"><i class="fas fa-coins text-xl"></i></div>
                            </div>
                        </div>
                        <!-- Card 2 -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition cursor-pointer group" onclick="switchTab('inventory')">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Low Stock Items</p>
                                    <h3 class="text-3xl font-bold text-red-600 mt-1 group-hover:scale-110 transition origin-left" id="low-stock-count">0</h3>
                                </div>
                                <div class="p-3 bg-red-100 text-red-600 rounded-xl"><i class="fas fa-box-open text-xl"></i></div>
                            </div>
                        </div>
                        <!-- Card 3 -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 hover:shadow-md transition">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider">Active Orders</p>
                                    <h3 class="text-3xl font-bold text-blue-600 mt-1" id="active-order-count">0</h3>
                                </div>
                                <div class="p-3 bg-blue-100 text-blue-600 rounded-xl"><i class="fas fa-clipboard-list text-xl"></i></div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h3 class="font-bold text-slate-700 mb-4">Recent Activity Log</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left">
                                <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b">
                                    <tr><th class="px-4 py-3">Time</th><th class="px-4 py-3">Action</th><th class="px-4 py-3">Details</th></tr>
                                </thead>
                                <tbody id="dashboard-logs" class="text-slate-600">
                                    <!-- Populated via JS -->
                                    <tr><td colspan="3" class="px-4 py-4 text-center italic text-slate-400">Loading logs...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 2. POS TAB -->
                <div id="tab-pos" class="content-tab hidden h-full flex flex-col md:flex-row fade-in overflow-hidden gap-4">
                    <!-- Left: Menu Grid -->
                    <div class="flex-1 flex flex-col bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <!-- Top Bar -->
                        <div class="p-4 border-b bg-slate-50 flex gap-4 items-center">
                            <div class="relative flex-1">
                                <i class="fas fa-search absolute left-3 top-3 text-slate-400"></i>
                                <input type="text" id="pos-search" placeholder="Search menu items..." class="w-full pl-10 pr-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none transition" onkeyup="filterPos()">
                            </div>
                        </div>
                        <!-- Categories -->
                        <div class="px-4 py-3 border-b bg-white overflow-x-auto custom-scrollbar flex gap-2" id="pos-categories">
                            <!-- Categories JS -->
                        </div>
                        <!-- Grid -->
                        <div id="pos-grid" class="flex-1 overflow-y-auto p-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 bg-slate-100 content-start custom-scrollbar">
                            <!-- Items JS -->
                        </div>
                    </div>

                    <!-- Right: Cart & Table Info -->
                    <div class="w-full md:w-[400px] flex flex-col bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden h-[60vh] md:h-auto">
                        <!-- Table Selector -->
                        <div class="p-4 bg-slate-800 text-white">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-sm uppercase opacity-75">Current Order</h3>
                                <span id="pos-status-badge" class="bg-orange-600 text-[10px] px-2 py-0.5 rounded font-bold hidden">ADDING TO ORDER</span>
                            </div>
                            <div id="selected-table-display" class="text-2xl font-bold truncate mb-3 text-orange-400">Select a Table</div>
                            <!-- Mini Table Grid -->
                            <div id="pos-table-grid" class="grid grid-cols-5 gap-1 max-h-24 overflow-y-auto custom-scrollbar pr-1">
                                <!-- Tables JS -->
                            </div>
                        </div>
                        
                        <!-- Cart Items -->
                        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 custom-scrollbar">
                            <div class="flex flex-col items-center justify-center h-full text-slate-400 opacity-50">
                                <i class="fas fa-shopping-basket text-4xl mb-2"></i>
                                <p class="text-sm">Cart is empty</p>
                            </div>
                        </div>

                        <!-- Cart Actions -->
                        <div class="p-4 bg-white border-t shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-10">
                            <div class="flex justify-between mb-1 text-sm text-slate-500">
                                <span>Subtotal</span>
                                <span id="cart-subtotal">₱0.00</span>
                            </div>
                            <div class="flex justify-between mb-4 text-2xl font-bold text-slate-800">
                                <span>Total</span>
                                <span id="cart-final-total">₱0.00</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                <button onclick="clearCart()" class="col-span-1 bg-slate-200 hover:bg-slate-300 text-slate-600 rounded-lg py-3 font-bold transition" title="Clear Cart"><i class="fas fa-trash-alt"></i></button>
                                <button onclick="openDiscountModal()" class="col-span-1 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg py-3 font-bold transition" title="Discount"><i class="fas fa-tags"></i></button>
                                <button id="btn-process-order" class="col-span-2 bg-gradient-to-r from-orange-600 to-orange-500 hover:from-orange-700 hover:to-orange-600 text-white rounded-lg py-3 font-bold shadow-lg transition flex items-center justify-center gap-2">
                                    Send Order <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. CASHIER TAB -->
                <div id="tab-cashier" class="content-tab hidden h-full flex flex-col p-4 md:p-6 fade-in">
                    <header class="mb-6">
                        <h2 class="text-3xl font-bold text-slate-800">Cashier Station</h2>
                        <p class="text-slate-500 text-sm">Manage tables and finalize payments.</p>
                    </header>
                    
                    <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-6 min-h-0">
                        <!-- Floor Map -->
                        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-200 p-6 overflow-y-auto custom-scrollbar">
                            <h3 class="font-bold text-xs text-slate-400 uppercase tracking-wider mb-4">Floor Plan Status</h3>
                            <div id="cashier-table-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                                <!-- Generated Tables -->
                            </div>
                        </div>

                        <!-- Order Detail Panel -->
                        <div class="bg-slate-50 rounded-2xl shadow-inner border border-slate-200 p-6 flex flex-col h-full">
                            <div id="cashier-order-detail" class="flex-1 flex flex-col">
                                <div class="flex flex-col items-center justify-center h-full text-slate-400">
                                    <i class="fas fa-hand-pointer text-4xl mb-4 opacity-30"></i>
                                    <p>Select an occupied table to view details.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 4. KITCHEN TAB -->
                <div id="tab-kitchen" class="content-tab hidden h-full flex flex-col p-4 md:p-6 fade-in">
                    <header class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-3xl font-bold text-slate-800">Kitchen Display</h2>
                            <p class="text-slate-500 text-sm">Live order monitoring.</p>
                        </div>
                        <div class="text-sm font-bold text-slate-500" id="kitchen-clock">00:00:00</div>
                    </header>
                    <div id="kitchen-orders-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 overflow-y-auto pb-20 custom-scrollbar">
                        <!-- Kitchen Tickets -->
                    </div>
                </div>

                <!-- 5. INVENTORY TAB -->
                <div id="tab-inventory" class="content-tab hidden h-full flex flex-col p-4 md:p-6 fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Inventory Management</h2>
                            <div class="flex gap-2 mt-2">
                                <button onclick="renderInventoryTable(false)" class="px-3 py-1 rounded-full text-xs font-bold bg-orange-600 text-white transition shadow-sm inv-filter-btn" id="btn-inv-menu">Menu Items</button>
                                <button onclick="renderInventoryTable(true)" class="px-3 py-1 rounded-full text-xs font-bold bg-slate-200 text-slate-600 hover:bg-slate-300 transition inv-filter-btn" id="btn-inv-ing">Ingredients</button>
                            </div>
                        </div>
                        <button onclick="document.getElementById('add-item-form-container').classList.toggle('hidden')" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow transition flex items-center gap-2">
                            <i class="fas fa-plus"></i> Add New Item
                        </button>
                    </div>

                    <!-- Add Item Form (Collapsible) -->
                    <div id="add-item-form-container" class="hidden bg-white p-6 rounded-xl shadow-lg mb-6 border-l-4 border-blue-500 animate-slide-in">
                        <h4 class="font-bold text-slate-700 mb-4">Create New Inventory Item</h4>
                        <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-6 gap-4 items-end">
                            <div class="md:col-span-2">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Item Name</label>
                                <input type="text" id="new-item-name" class="w-full border-slate-300 rounded p-2 text-sm" placeholder="e.g., Sisig" required>
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Category</label>
                                <select id="new-item-category" class="w-full border-slate-300 rounded p-2 text-sm"></select>
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Price</label>
                                <input type="number" id="new-item-price" class="w-full border-slate-300 rounded p-2 text-sm" placeholder="0.00" step="0.01" required>
                            </div>
                            <div class="md:col-span-1">
                                <label class="block text-xs font-bold text-slate-500 mb-1">Initial Stock</label>
                                <input type="number" id="new-item-stock" class="w-full border-slate-300 rounded p-2 text-sm" placeholder="0" required>
                            </div>
                            <div class="md:col-span-1 flex items-center gap-2 pb-2">
                                <input type="checkbox" id="new-item-ingredient" class="w-4 h-4 rounded text-blue-600">
                                <label for="new-item-ingredient" class="text-sm font-bold text-slate-600">Ingredient?</label>
                            </div>
                            <div class="md:col-span-6 flex justify-end">
                                <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700 shadow">Save Item</button>
                            </div>
                        </form>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col">
                        <div class="overflow-x-auto flex-1 custom-scrollbar">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase">
                                    <tr>
                                        <th class="px-6 py-4 border-b">Item Name</th>
                                        <th class="px-6 py-4 border-b">Category</th>
                                        <th class="px-6 py-4 border-b">Price</th>
                                        <th class="px-6 py-4 border-b text-center">Stock</th>
                                        <th class="px-6 py-4 border-b text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="inventory-table-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                                    <!-- Rows JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 6. HISTORY TAB -->
                <div id="tab-history" class="content-tab hidden h-full flex flex-col p-4 md:p-6 fade-in">
                    <header class="mb-6 flex justify-between items-center">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Transaction History</h2>
                            <p class="text-slate-500 text-sm">Audit logs and completed sales.</p>
                        </div>
                        <div class="role-admin hidden">
                            <button onclick="resetSalesData()" class="text-red-500 hover:text-red-700 text-xs font-bold underline">Reset Database (Admin)</button>
                        </div>
                    </header>
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex-1 flex flex-col">
                        <div class="overflow-x-auto flex-1 custom-scrollbar">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase">
                                    <tr>
                                        <th class="px-6 py-4 border-b">Date & Time</th>
                                        <th class="px-6 py-4 border-b">Order ID</th>
                                        <th class="px-6 py-4 border-b">Details</th>
                                        <th class="px-6 py-4 border-b text-right">Total</th>
                                        <th class="px-6 py-4 border-b text-right">Payment</th>
                                        <th class="px-6 py-4 border-b text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="history-table-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                                    <!-- Rows JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 7. SETTINGS TAB (Admin & Role Sim) -->
                <div id="tab-settings" class="content-tab hidden h-full p-4 md:p-6 fade-in overflow-y-auto">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Application Info (Visible to All) -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                             <h3 class="font-bold text-lg mb-4 text-slate-700">Application Info</h3>
                             <p class="text-sm"><span class="font-bold">Version:</span> 2.6.0 Enterprise</p>
                             <p class="text-sm"><span class="font-bold">Build:</span> Stable</p>
                             <p class="text-sm"><span class="font-bold">Support:</span> support@sambuwig.com</p>
                             <div class="mt-6 pt-6 border-t">
                                <p class="text-xs text-slate-400">© 2024 Sambuwig Inc. All rights reserved.</p>
                             </div>
                        </div>

                        <!-- Role Simulator (Admin Only) -->
                        <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 role-admin hidden">
                            <h3 class="font-bold text-lg mb-4 text-slate-700">Role Simulator (Admin Only)</h3>
                            <p class="text-sm text-slate-500 mb-4">Switch views to test different permission levels.</p>
                            <div class="space-y-2">
                                <button onclick="switchRole('admin')" class="w-full text-left p-3 rounded-lg border hover:bg-slate-50 flex justify-between items-center group transition">
                                    <span class="font-bold text-slate-700">Administrator</span>
                                    <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">Full Access</span>
                                </button>
                                <button onclick="switchRole('oversee')" class="w-full text-left p-3 rounded-lg border hover:bg-slate-50 flex justify-between items-center group transition">
                                    <span class="font-bold text-slate-700">Oversee</span>
                                    <span class="text-xs bg-purple-100 text-purple-600 px-2 py-1 rounded">Management View</span>
                                </button>
                                <button onclick="switchRole('waiter')" class="w-full text-left p-3 rounded-lg border hover:bg-slate-50 flex justify-between items-center group transition">
                                    <span class="font-bold text-slate-700">Waiter</span>
                                    <span class="text-xs bg-green-100 text-green-600 px-2 py-1 rounded">POS Focused</span>
                                </button>
                                <button onclick="switchRole('kitchen')" class="w-full text-left p-3 rounded-lg border hover:bg-slate-50 flex justify-between items-center group transition">
                                    <span class="font-bold text-slate-700">Kitchen Staff</span>
                                    <span class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded">Display Only</span>
                                </button>
                            </div>
                        </div>

                        <!-- User Management (Admin Only) -->
                        <div class="md:col-span-2 bg-white p-6 rounded-2xl shadow-sm border border-slate-200 role-admin hidden">
                            <h3 class="font-bold text-lg mb-4 text-slate-700">User Management</h3>
                            
                            <!-- Add User Form -->
                            <form id="add-user-form" class="flex flex-wrap gap-4 mb-6 bg-slate-50 p-4 rounded-xl items-end">
                                <div class="flex-1">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Email</label>
                                    <input type="email" id="new-user-email" class="w-full border-slate-300 rounded p-2 text-sm" placeholder="user@sambuwig.com" required>
                                </div>
                                <div class="w-40">
                                    <label class="block text-xs font-bold text-slate-500 mb-1">Role</label>
                                    <select id="new-user-role" class="w-full border-slate-300 rounded p-2 text-sm">
                                        <option value="waiter">Waiter</option>
                                        <option value="kitchen">Kitchen</option>
                                        <option value="oversee">Oversee</option>
                                        <option value="admin">Admin</option>
                                    </select>
                                </div>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-bold text-sm shadow">Add Account</button>
                            </form>

                            <!-- User List -->
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-slate-50 text-xs font-bold text-slate-500 uppercase">
                                        <tr>
                                            <th class="px-4 py-3">Email</th>
                                            <th class="px-4 py-3">Role</th>
                                            <th class="px-4 py-3 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-list-body" class="text-slate-600 divide-y divide-slate-100">
                                        <!-- Users JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- ================================================================================== -->
    <!--                                  JAVASCRIPT LOGIC                                   -->
    <!-- ================================================================================== -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, runTransaction, query, where, orderBy, getDocs, setDoc, deleteDoc, writeBatch, limit, getDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5L9S3_diMaKQ7IyXEnyhEuWOHz8-QTvY",
            authDomain: "my-pos-system-3683a.firebaseapp.com",
            projectId: "my-pos-system-3683a",
            storageBucket: "my-pos-system-3683a.firebasestorage.app",
            messagingSenderId: "1040426979758",
            appId: "1:1040426979758:web:da01b11782d68dac86f83f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE VARIABLES ---
        let currentUser = null;
        let currentRole = 'waiter';
        let inventoryData = [];
        let activeOrders = [];
        let salesHistory = [];
        let tablesData = [];
        let usersData = [];
        let cart = {}; 
        let selectedTableId = null;
        let activeOrderIdForTable = null; 
        let clockInterval;

        const CATEGORIES = [
            "Appetizers", "Soup", "Salad", "Pasta", "Seafood", "Chicken", "Beef", "Pork", "Vegetable", 
            "Breakfast", "Sandwiches", "Desserts", "Juice", "Pitcher", "Soda", "Hot", "Shakes"
        ];

        // --- AUTHENTICATION FLOW ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email-display').textContent = user.email;
                document.getElementById('user-avatar').textContent = user.email[0].toUpperCase();
                
                // Fetch Role from 'users' collection or default
                await fetchUserRole(user.email);

                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-layout').classList.remove('hidden');
                
                applyRoleUI();
                initRealtimeListeners();
                startClock();
                showToast(`Welcome back, ${currentRole.toUpperCase()}`, 'info');
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('main-layout').classList.add('hidden');
                clearInterval(clockInterval);
            }
        });

        async function fetchUserRole(email) {
            // Priority check for hardcoded admin
            if (email.includes('admin')) {
                currentRole = 'admin';
                return;
            }
            
            // Check Firestore 'users' collection
            const q = query(collection(db, "users"), where("email", "==", email));
            const snap = await getDocs(q);
            if (!snap.empty) {
                currentRole = snap.docs[0].data().role || 'waiter';
            } else {
                // Heuristic Fallback
                if (email.includes('kitchen')) currentRole = 'kitchen';
                else if (email.includes('oversee')) currentRole = 'oversee';
                else currentRole = 'waiter';
            }
        }

        // --- INITIALIZATION ---
        function initRealtimeListeners() {
            setLoading(true);
            
            // 1. INVENTORY
            onSnapshot(query(collection(db, "inventory"), orderBy("name")), (snap) => {
                inventoryData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderPosCategories();
                filterPos();
                renderInventoryTable(false);
                updateDashboard();
            });

            // 2. ACTIVE ORDERS
            onSnapshot(collection(db, "active_orders"), (snap) => {
                activeOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderKitchen();
                renderCashier();
                renderPosTables();
                updateDashboard();
                updateBadges();
            });

            // 3. TABLES
            onSnapshot(collection(db, "tables"), (snap) => {
                tablesData = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                    .sort((a, b) => parseInt(a.name.replace(/\D/g,'')) - parseInt(b.name.replace(/\D/g,'')));
                if (tablesData.length === 0) seedTables();
                renderPosTables();
                renderCashier();
            });

            // 4. SALES HISTORY
            onSnapshot(query(collection(db, "sales"), orderBy("completedAt", "desc"), limit(100)), (snap) => {
                salesHistory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderHistory();
                updateDashboard();
                checkPayables();
                setLoading(false);
            });

            // 5. USERS (Admin Only)
            if (currentRole === 'admin') {
                onSnapshot(collection(db, "users"), (snap) => {
                    usersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    renderUserList();
                });
            }
        }

        async function seedTables() {
            const batch = writeBatch(db);
            for (let i = 1; i <= 12; i++) batch.set(doc(collection(db, "tables")), { name: `Table ${i}` });
            await batch.commit();
        }

        // --- USER MANAGEMENT (ADMIN) ---
        function renderUserList() {
            const tbody = document.getElementById('user-list-body');
            tbody.innerHTML = '';
            
            if (usersData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-4 py-3 text-center italic">No users found. Add one above.</td></tr>';
                return;
            }

            usersData.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-3">${u.email}</td>
                    <td class="px-4 py-3 uppercase font-bold text-xs">${u.role}</td>
                    <td class="px-4 py-3 text-right">
                        <select onchange="updateUserRole('${u.id}', this.value)" class="border rounded text-xs p-1">
                            <option value="waiter" ${u.role==='waiter'?'selected':''}>Waiter</option>
                            <option value="kitchen" ${u.role==='kitchen'?'selected':''}>Kitchen</option>
                            <option value="oversee" ${u.role==='oversee'?'selected':''}>Oversee</option>
                            <option value="admin" ${u.role==='admin'?'selected':''}>Admin</option>
                        </select>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.updateUserRole = async (id, newRole) => {
            try {
                await updateDoc(doc(db, "users", id), { role: newRole });
                showToast("User role updated", "success");
            } catch(e) { showToast("Error updating role", "error"); }
        };

        document.getElementById('add-user-form').onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('new-user-email').value;
            const role = document.getElementById('new-user-role').value;
            
            // Check duplicates
            if (usersData.some(u => u.email === email)) return showToast("User email already exists", "error");

            try {
                await addDoc(collection(db, "users"), { email, role });
                document.getElementById('new-user-email').value = '';
                showToast("User added. They can now log in.", "success");
            } catch(e) { showToast("Error adding user", "error"); }
        };

        // --- DASHBOARD LOGIC ---
        window.updateDashboard = () => {
            const today = new Date().toLocaleDateString();
            document.getElementById('dash-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            const todaySales = salesHistory
                .filter(s => new Date(s.completedAt).toLocaleDateString() === today)
                .reduce((acc, curr) => acc + (curr.total || 0), 0);
            
            document.getElementById('total-sales').textContent = '₱' + todaySales.toLocaleString(undefined, { minimumFractionDigits: 2 });
            document.getElementById('low-stock-count').textContent = inventoryData.filter(i => i.stock < 10 && !i.isIngredient).length;
            document.getElementById('active-order-count').textContent = activeOrders.length;

            const logBody = document.getElementById('dashboard-logs');
            logBody.innerHTML = '';
            const recentLogs = [...salesHistory].slice(0, 5);
            if (recentLogs.length === 0) {
                logBody.innerHTML = '<tr><td colspan="3" class="px-4 py-4 text-center italic text-slate-400">No recent activity</td></tr>';
            } else {
                recentLogs.forEach(log => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b hover:bg-slate-50";
                    tr.innerHTML = `
                        <td class="px-4 py-3 text-xs">${new Date(log.completedAt).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                        <td class="px-4 py-3"><span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-bold">SALE</span></td>
                        <td class="px-4 py-3 text-xs text-slate-500">Order #${log.id.slice(0,4)} - ₱${log.total.toFixed(2)}</td>
                    `;
                    logBody.appendChild(tr);
                });
            }
        };

        function updateBadges() {
            const kitchenCount = activeOrders.filter(o => o.status === 'pending').length;
            const cashierCount = activeOrders.length;
            
            const kBadge = document.getElementById('kitchen-badge');
            const cBadge = document.getElementById('cashier-badge');
            
            if (kitchenCount > 0) {
                kBadge.textContent = kitchenCount;
                kBadge.classList.remove('hidden');
            } else {
                kBadge.classList.add('hidden');
            }

            if (cashierCount > 0) {
                cBadge.textContent = cashierCount;
                cBadge.classList.remove('hidden');
            } else {
                cBadge.classList.add('hidden');
            }
        }

        // --- POS LOGIC ---
        function renderPosCategories() {
            const container = document.getElementById('pos-categories');
            if (!container.hasChildNodes()) {
                container.innerHTML = `<button onclick="filterPos('All')" class="category-btn active px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-full text-xs font-bold whitespace-nowrap shadow-sm hover:bg-slate-50 transition" id="cat-btn-All">All Items</button>`;
                CATEGORIES.forEach(c => {
                    container.innerHTML += `<button onclick="filterPos('${c}')" class="category-btn px-4 py-2 bg-white border border-slate-200 text-slate-600 rounded-full text-xs font-bold whitespace-nowrap shadow-sm hover:bg-slate-50 transition" id="cat-btn-${c.replace(/\s/g,'')}">${c}</button>`;
                });
            }
        }

        window.filterPos = (category) => {
            const term = document.getElementById('pos-search').value.toLowerCase();
            const grid = document.getElementById('pos-grid');
            if (!grid) return;
            
            if (category) {
                document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                const btnId = 'cat-btn-' + category.replace(/\s/g,'');
                const btn = document.getElementById(btnId);
                if (btn) btn.classList.add('active');
                window.currentCategory = category;
            }
            
            const activeCat = window.currentCategory || 'All';
            grid.innerHTML = '';

            const filtered = inventoryData.filter(i => {
                const matchesCat = activeCat === 'All' || i.category === activeCat;
                const matchesSearch = i.name.toLowerCase().includes(term);
                const isMenuItem = !i.isIngredient; 
                return matchesCat && matchesSearch && isMenuItem;
            });

            if (filtered.length === 0) {
                grid.innerHTML = `<div class="col-span-full text-center text-slate-400 mt-10 italic">No items found matching criteria.</div>`;
                return;
            }

            filtered.forEach(i => {
                const el = document.createElement('div');
                el.className = "pos-card bg-white p-4 rounded-xl shadow-sm border border-slate-200 cursor-pointer relative overflow-hidden h-32 flex flex-col justify-between";
                const stockColor = i.stock <= 0 ? 'bg-red-500' : (i.stock < 10 ? 'bg-orange-500' : 'bg-green-500');
                el.innerHTML = `
                    <div class="absolute top-0 right-0 w-3 h-3 rounded-bl-lg ${stockColor}"></div>
                    <div>
                        <h4 class="font-bold text-slate-700 leading-tight mb-1">${i.name}</h4>
                        <p class="text-[10px] text-slate-500 uppercase font-bold">${i.category}</p>
                    </div>
                    <div class="flex justify-between items-end mt-2">
                        <span class="font-bold text-orange-600 text-lg">₱${i.price}</span>
                        <span class="text-[10px] text-slate-400 font-mono">Qty: ${i.stock}</span>
                    </div>
                `;
                el.onclick = () => addToCart(i);
                grid.appendChild(el);
            });
        };

        function renderPosTables() {
            const grid = document.getElementById('pos-table-grid');
            grid.innerHTML = '';
            tablesData.forEach(t => {
                const activeOrder = activeOrders.find(o => o.tableId === t.id);
                const btn = document.createElement('div');
                const isSelected = selectedTableId === t.id;
                let statusClass = activeOrder ? 'bg-red-100 border-red-300 text-red-700' : 'bg-green-50 border-green-200 text-green-700 hover:bg-green-100';
                if (isSelected) statusClass = 'bg-slate-800 text-white border-slate-900 ring-2 ring-orange-400';
                btn.className = `p-2 rounded border text-center cursor-pointer transition text-xs font-bold relative ${statusClass}`;
                btn.innerHTML = `${t.name.replace('Table ','')}`;
                if (activeOrder) btn.innerHTML += `<div class="absolute -top-1 -right-1 w-2 h-2 bg-red-500 rounded-full"></div>`;
                btn.onclick = () => selectTable(t.id, activeOrder);
                grid.appendChild(btn);
            });
        }

        function selectTable(tId, existingOrder) {
            selectedTableId = tId;
            activeOrderIdForTable = existingOrder ? existingOrder.id : null;
            const tableObj = tablesData.find(t => t.id === tId);
            const display = document.getElementById('selected-table-display');
            const badge = document.getElementById('pos-status-badge');
            display.textContent = tableObj.name;
            if (existingOrder) {
                badge.classList.remove('hidden');
                display.classList.add('text-orange-300');
                display.classList.remove('text-white');
            } else {
                badge.classList.add('hidden');
                display.classList.remove('text-orange-300');
                display.classList.add('text-white');
            }
            renderPosTables();
        }

        window.addToCart = (item) => {
            if (item.stock <= 0) return showToast(`${item.name} is out of stock!`, 'error');
            if (!cart[item.id]) cart[item.id] = { item, qty: 0, discount: 0, discountType: 'none', discountDetails: '' };
            cart[item.id].qty++;
            renderCart();
        };

        window.removeFromCart = (id) => { delete cart[id]; renderCart(); };
        window.clearCart = () => { cart = {}; renderCart(); };

        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let subtotal = 0;
            let total = 0;
            const items = Object.values(cart);
            if (items.length === 0) {
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400 opacity-50"><i class="fas fa-shopping-basket text-4xl mb-2"></i><p class="text-sm">Cart is empty</p></div>`;
                document.getElementById('cart-subtotal').textContent = '₱0.00';
                document.getElementById('cart-final-total').textContent = '₱0.00';
                return;
            }
            items.forEach(c => {
                const itemTotal = c.item.price * c.qty;
                const discountAmt = itemTotal * (c.discount / 100);
                const finalItemTotal = itemTotal - discountAmt;
                subtotal += itemTotal;
                total += finalItemTotal;
                const el = document.createElement('div');
                el.className = "bg-white p-3 rounded-lg border border-slate-100 shadow-sm flex justify-between items-center relative group";
                el.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-slate-700">${c.item.name}</span>
                            ${c.discount > 0 ? `<span class="text-[10px] bg-purple-100 text-purple-700 px-1 rounded">-${c.discount}%</span>` : ''}
                        </div>
                        <div class="text-xs text-slate-500">${c.qty} x ₱${c.item.price}</div>
                    </div>
                    <div class="text-right mr-3">
                        <div class="font-bold text-slate-800">₱${finalItemTotal.toFixed(2)}</div>
                        ${c.discount > 0 ? `<div class="text-[10px] text-slate-400 line-through">₱${itemTotal.toFixed(2)}</div>` : ''}
                    </div>
                    <button onclick="removeFromCart('${c.item.id}')" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-times-circle"></i></button>
                `;
                container.appendChild(el);
            });
            document.getElementById('cart-subtotal').textContent = '₱' + subtotal.toFixed(2);
            document.getElementById('cart-final-total').textContent = '₱' + total.toFixed(2);
        }

        // --- DISCOUNT MODULE ---
        window.openDiscountModal = () => {
            if (Object.keys(cart).length === 0) return showToast("Cart is empty", "error");
            const list = document.getElementById('discount-item-list');
            list.innerHTML = '';
            Object.values(cart).forEach(c => {
                const row = document.createElement('label');
                row.className = "flex items-center p-2 hover:bg-slate-100 rounded cursor-pointer";
                row.innerHTML = `<input type="checkbox" value="${c.item.id}" class="disc-check w-4 h-4 text-purple-600 rounded border-slate-300 mr-3" checked><span class="text-sm text-slate-700 font-medium flex-1">${c.item.name}</span><span class="text-xs text-slate-400">₱${(c.item.price*c.qty).toFixed(2)}</span>`;
                list.appendChild(row);
            });
            setDiscountType('custom');
            document.getElementById('modal-discount').classList.remove('hidden');
        };

        window.toggleAllDiscountItems = (checked) => { document.querySelectorAll('.disc-check').forEach(c => c.checked = checked); };

        window.setDiscountType = (type) => {
            document.querySelectorAll('.disc-type-btn').forEach(b => b.classList.remove('bg-purple-50', 'border-purple-500', 'ring-2'));
            document.querySelectorAll('.disc-input-group').forEach(g => g.classList.add('hidden'));
            document.getElementById('selected-discount-type').value = type;
            let btnId = type === 'custom' ? 'btn-disc-custom' : (type === 'pwd_senior' ? 'btn-disc-senior' : 'btn-disc-emp');
            document.getElementById(btnId).classList.add('bg-purple-50', 'border-purple-500', 'ring-2');
            let inputId = type === 'custom' ? 'input-custom' : (type === 'pwd_senior' ? 'input-senior' : 'input-employee');
            document.getElementById(inputId).classList.remove('hidden');
        };

        window.applyDiscountConfirm = () => {
            const type = document.getElementById('selected-discount-type').value;
            const checkedIds = Array.from(document.querySelectorAll('.disc-check:checked')).map(cb => cb.value);
            if (checkedIds.length === 0) return showToast("Select at least one item", "error");
            let percent = 0;
            let detail = "";
            if (type === 'custom') {
                percent = parseFloat(document.getElementById('disc-percent').value);
                if (isNaN(percent) || percent < 0) return showToast("Invalid percentage", "error");
                detail = "Manual";
            } else if (type === 'pwd_senior') {
                const idNum = document.getElementById('disc-id-num').value.trim();
                if (!idNum) return showToast("ID Number Required", "error");
                percent = 20;
                detail = `ID: ${idNum}`;
            } else if (type === 'employee') {
                const u = document.getElementById('disc-emp-user').value;
                const p = document.getElementById('disc-emp-pass').value;
                if (u !== 'emp' || p !== '123') return showToast("Invalid Credentials", "error");
                percent = 10;
                detail = `Emp: ${u}`;
            }
            checkedIds.forEach(id => {
                if (cart[id]) {
                    cart[id].discount = percent;
                    cart[id].discountType = type;
                    cart[id].discountDetails = detail;
                }
            });
            renderCart();
            closeModal('modal-discount');
            showToast("Discount Applied", "success");
        };

        // --- ORDER SUBMISSION ---
        document.getElementById('btn-process-order').onclick = async () => {
            if (!selectedTableId) return showToast("Please select a table first", "error");
            if (Object.keys(cart).length === 0) return showToast("Cart is empty", "error");
            setLoading(true);
            const cartItems = Object.values(cart);
            const tableObj = tablesData.find(t => t.id === selectedTableId);
            const newItems = cartItems.map(c => ({
                id: c.item.id,
                name: c.item.name,
                price: c.item.price,
                qty: c.qty,
                discount: c.discount,
                discountType: c.discountType,
                discountDetails: c.discountDetails,
                status: 'pending',
                kitchenNotes: ''
            }));
            const batchTotal = cartItems.reduce((acc, c) => acc + (c.qty * c.item.price * ((100 - c.discount)/100)), 0);
            try {
                const batch = writeBatch(db);
                newItems.forEach(i => {
                    const itemData = inventoryData.find(inv => inv.id === i.id);
                    if (itemData) batch.update(doc(db, "inventory", i.id), { stock: itemData.stock - i.qty });
                });
                await batch.commit();
                if (activeOrderIdForTable) {
                    const orderRef = doc(db, "active_orders", activeOrderIdForTable);
                    const snap = await getDoc(orderRef);
                    if (snap.exists()) {
                        const existingData = snap.data();
                        await updateDoc(orderRef, {
                            items: [...existingData.items, ...newItems],
                            total: existingData.total + batchTotal,
                            lastUpdated: new Date().toISOString()
                        });
                    }
                } else {
                    await addDoc(collection(db, "active_orders"), {
                        tableId: selectedTableId,
                        tableName: tableObj.name,
                        items: newItems,
                        total: batchTotal,
                        status: 'pending',
                        timestamp: new Date().toISOString(),
                        staff: currentUser.email
                    });
                }
                cart = {};
                renderCart();
                selectedTableId = null;
                activeOrderIdForTable = null;
                document.getElementById('selected-table-display').textContent = "Select Table";
                document.getElementById('pos-status-badge').classList.add('hidden');
                showToast("Order sent to Kitchen!", "success");
            } catch (e) {
                console.error(e);
                showToast("Failed to process order", "error");
            } finally { setLoading(false); }
        };

        // --- KITCHEN LOGIC ---
        function renderKitchen() {
            const container = document.getElementById('kitchen-orders-list');
            container.innerHTML = '';
            const pendingOrders = activeOrders.filter(o => o.status !== 'completed').sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            if (pendingOrders.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center text-slate-400 mt-20"><i class="fas fa-check-circle text-6xl mb-4"></i><p>All caught up!</p></div>`;
                return;
            }
            pendingOrders.forEach(order => {
                const el = document.createElement('div');
                el.className = "bg-white rounded-xl shadow-md border-t-4 border-orange-500 overflow-hidden flex flex-col";
                const timeDiff = Math.floor((new Date() - new Date(order.timestamp)) / 60000);
                const timerColor = timeDiff > 30 ? 'text-red-600 animate-pulse' : 'text-slate-500';
                let itemsHtml = '';
                let allCooked = true;
                order.items.forEach((item, idx) => {
                    const isCooked = item.status === 'cooked';
                    if (!isCooked) allCooked = false;
                    itemsHtml += `
                        <div class="flex items-center p-3 border-b border-dashed border-slate-100 hover:bg-slate-50 transition">
                            <input type="checkbox" class="kitchen-checkbox mr-3" ${isCooked ? 'checked disabled' : ''} onchange="updateKitchenItemStatus('${order.id}', ${idx}, this.checked)">
                            <div class="flex-1 ${isCooked ? 'item-cooked' : ''}">
                                <span class="font-bold text-lg mr-2">${item.qty}x</span>
                                <span class="text-sm font-medium">${item.name}</span>
                            </div>
                        </div>`;
                });
                el.innerHTML = `
                    <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
                        <h3 class="font-bold text-lg text-slate-800">${order.tableName}</h3>
                        <div class="text-right"><p class="text-[10px] font-bold text-slate-400 uppercase">Wait Time</p><p class="font-mono text-sm font-bold ${timerColor}">${timeDiff} mins</p></div>
                    </div>
                    <div class="flex-1 overflow-y-auto bg-white">${itemsHtml}</div>
                    ${allCooked ? `<div class="p-3 bg-green-100 text-green-700 text-center font-bold text-sm"><i class="fas fa-check-double mr-1"></i> Order Ready</div>` : ''}`;
                container.appendChild(el);
            });
        }

        window.updateKitchenItemStatus = async (orderId, itemIdx, isChecked) => {
            const orderRef = doc(db, "active_orders", orderId);
            const snap = await getDoc(orderRef);
            if (!snap.exists()) return;
            const items = snap.data().items;
            items[itemIdx].status = isChecked ? 'cooked' : 'pending';
            await updateDoc(orderRef, { items });
        };

        // --- CASHIER LOGIC ---
        function renderCashier() {
            const grid = document.getElementById('cashier-table-grid');
            grid.innerHTML = '';
            tablesData.forEach(t => {
                const order = activeOrders.find(o => o.tableId === t.id);
                const el = document.createElement('div');
                const hasOrder = !!order;
                el.className = `p-4 rounded-xl border-2 transition cursor-pointer flex flex-col items-center justify-center h-32 relative shadow-sm hover:shadow-md ${hasOrder ? 'bg-blue-50 border-blue-400 text-blue-900' : 'bg-white border-slate-200 text-slate-400 hover:border-orange-300'}`;
                el.innerHTML = `<div class="font-bold text-lg mb-1">${t.name}</div><div class="text-xs font-bold uppercase ${hasOrder ? 'text-blue-600' : 'text-slate-300'}">${hasOrder ? 'Occupied' : 'Vacant'}</div>${hasOrder ? `<div class="mt-2 font-mono font-bold">₱${order.total.toFixed(2)}</div>` : ''}`;
                el.onclick = () => showCashierDetails(order);
                grid.appendChild(el);
            });
        }

        function showCashierDetails(order) {
            const panel = document.getElementById('cashier-order-detail');
            if (!order) {
                panel.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400"><i class="fas fa-hand-pointer text-4xl mb-4 opacity-30"></i><p>Select an occupied table to view details.</p></div>`;
                return;
            }
            const isReady = order.items.every(i => i.status === 'cooked');
            const itemsList = order.items.map(i => `<div class="flex justify-between py-1 border-b border-dashed border-slate-200 last:border-0"><span class="text-sm"><span class="font-bold">${i.qty}x</span> ${i.name}</span><span class="text-sm font-mono">₱${(i.price * i.qty * ((100-(i.discount||0))/100)).toFixed(2)}</span></div>`).join('');
            panel.innerHTML = `
                <div class="flex-1 flex flex-col">
                    <div class="border-b pb-4 mb-4">
                        <div class="flex justify-between items-center mb-2"><h2 class="text-2xl font-bold text-slate-800">${order.tableName}</h2><span class="px-3 py-1 rounded-full text-xs font-bold ${isReady ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${isReady ? 'Ready to Serve' : 'Preparing'}</span></div>
                        <p class="text-xs text-slate-500">Order ID: #${order.id.slice(0,6)}</p>
                    </div>
                    <div class="flex-1 overflow-y-auto custom-scrollbar pr-2 mb-4">${itemsList}</div>
                    <div class="bg-slate-100 p-4 rounded-xl mb-4"><div class="flex justify-between items-center mb-1"><span class="text-sm text-slate-500">Total Amount</span><span class="text-3xl font-bold text-slate-800">₱${order.total.toFixed(2)}</span></div></div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="finalizePayment('${order.id}', 'cash')" class="bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow transition flex items-center justify-center gap-2"><i class="fas fa-money-bill-wave"></i> Pay Cash</button>
                        <button onclick="promptPayable('${order.id}')" class="bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-xl font-bold shadow transition flex items-center justify-center gap-2"><i class="fas fa-file-invoice"></i> Payable</button>
                        <button onclick="printReceipt('${order.id}')" class="col-span-2 bg-slate-700 hover:bg-slate-800 text-white py-3 rounded-xl font-bold shadow transition flex items-center justify-center gap-2"><i class="fas fa-print"></i> Print Bill</button>
                    </div>
                </div>`;
        }

        // --- PAYMENT LOGIC ---
        let pendingPayableId = null;
        window.promptPayable = (id) => {
            pendingPayableId = id;
            document.getElementById('modal-payable').classList.remove('hidden');
        };

        window.confirmPayable = () => {
            const u = document.getElementById('pay-user').value;
            const p = document.getElementById('pay-pass').value;
            if (u === 'smbwg' && p === 'admin') {
                const dueDate = new Date();
                dueDate.setDate(dueDate.getDate() + 3);
                finalizePayment(pendingPayableId, 'payable', { accountName: u, dueDate: dueDate.toISOString(), authorizedBy: currentUser.email });
                closeModal('modal-payable');
            } else { showToast("Invalid Credentials", "error"); }
        };

        window.finalizePayment = async (orderId, method, details = null) => {
            setLoading(true);
            try {
                const order = activeOrders.find(o => o.id === orderId);
                if (!order) throw new Error("Order not found");
                const saleData = { ...order, completedAt: new Date().toISOString(), paymentMethod: method, paymentStatus: method === 'payable' ? 'pending' : 'paid', payableDetails: details || {} };
                await addDoc(collection(db, "sales"), saleData);
                await deleteDoc(doc(db, "active_orders", orderId));
                showToast("Transaction Completed!", "success");
                renderCashier();
                document.getElementById('cashier-order-detail').innerHTML = `<div class="flex flex-col items-center justify-center h-full text-slate-400"><i class="fas fa-check-circle text-5xl mb-4 text-green-500"></i><p>Payment Successful</p></div>`;
            } catch (e) { showToast("Transaction Failed", "error"); } finally { setLoading(false); }
        };

        // --- INVENTORY MANAGEMENT ---
        document.getElementById('add-item-form').onsubmit = async (e) => {
            e.preventDefault();
            setLoading(true);
            try {
                const item = {
                    name: document.getElementById('new-item-name').value,
                    category: document.getElementById('new-item-category').value,
                    price: parseFloat(document.getElementById('new-item-price').value),
                    stock: parseInt(document.getElementById('new-item-stock').value),
                    isIngredient: document.getElementById('new-item-ingredient').checked,
                    lastUpdated: new Date().toISOString()
                };
                await addDoc(collection(db, "inventory"), item);
                e.target.reset();
                document.getElementById('add-item-form-container').classList.add('hidden');
                showToast("Item Created", "success");
            } catch (e) { showToast("Error adding item", "error"); } finally { setLoading(false); }
        };

        window.renderInventoryTable = (showIngredients) => {
            const btnMenu = document.getElementById('btn-inv-menu');
            const btnIng = document.getElementById('btn-inv-ing');
            if (showIngredients) {
                btnMenu.classList.replace('bg-orange-600', 'bg-slate-200'); btnMenu.classList.replace('text-white', 'text-slate-600');
                btnIng.classList.replace('bg-slate-200', 'bg-orange-600'); btnIng.classList.replace('text-slate-600', 'text-white');
            } else {
                btnIng.classList.replace('bg-orange-600', 'bg-slate-200'); btnIng.classList.replace('text-white', 'text-slate-600');
                btnMenu.classList.replace('bg-slate-200', 'bg-orange-600'); btnMenu.classList.replace('text-slate-600', 'text-white');
            }
            const tbody = document.getElementById('inventory-table-body');
            tbody.innerHTML = '';
            const filtered = inventoryData.filter(i => !!i.isIngredient === showIngredients);
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-slate-400 italic">No items found in this view.</td></tr>';
                return;
            }
            filtered.forEach(i => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition";
                const stockColor = i.stock < 10 ? 'text-red-600 font-bold' : 'text-slate-700';
                tr.innerHTML = `
                    <td class="px-6 py-4 border-b font-medium">${i.name}</td>
                    <td class="px-6 py-4 border-b"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs">${i.category || 'N/A'}</span></td>
                    <td class="px-6 py-4 border-b">₱${i.price.toFixed(2)}</td>
                    <td class="px-6 py-4 border-b text-center ${stockColor}">${i.stock}</td>
                    <td class="px-6 py-4 border-b text-right space-x-2">
                        <button onclick="editInventoryItem('${i.id}')" class="text-blue-500 hover:text-blue-700 bg-blue-50 p-2 rounded transition"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteInventoryItem('${i.id}')" class="text-red-500 hover:text-red-700 bg-red-50 p-2 rounded transition"><i class="fas fa-trash"></i></button>
                    </td>`;
                tbody.appendChild(tr);
            });
        };

        window.editInventoryItem = (id) => {
            const item = inventoryData.find(i => i.id === id);
            if (!item) return;
            document.getElementById('edit-item-id').value = id;
            document.getElementById('edit-item-name').value = item.name;
            document.getElementById('edit-item-price').value = item.price;
            document.getElementById('edit-item-stock').value = item.stock;
            document.getElementById('modal-edit-item').classList.remove('hidden');
        };

        window.saveItemEdit = async () => {
            const id = document.getElementById('edit-item-id').value;
            setLoading(true);
            try {
                await updateDoc(doc(db, "inventory", id), {
                    name: document.getElementById('edit-item-name').value,
                    price: parseFloat(document.getElementById('edit-item-price').value),
                    stock: parseInt(document.getElementById('edit-item-stock').value)
                });
                closeModal('modal-edit-item');
                showToast("Item Updated", "success");
            } catch (e) { showToast("Update Failed", "error"); } finally { setLoading(false); }
        };

        window.deleteInventoryItem = async (id) => {
            if (confirm("Are you sure you want to delete this item?")) {
                await deleteDoc(doc(db, "inventory", id));
                showToast("Item Deleted", "success");
            }
        };

        // --- HISTORY & ADMIN ---
        function renderHistory() {
            const tbody = document.getElementById('history-table-body');
            tbody.innerHTML = '';
            salesHistory.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition";
                const isPayable = s.paymentMethod === 'payable';
                const statusBadge = isPayable && s.paymentStatus === 'pending' 
                    ? '<span class="bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded uppercase">Unpaid</span>' 
                    : '<span class="bg-green-100 text-green-600 text-[10px] font-bold px-2 py-1 rounded uppercase">Paid</span>';
                
                tr.innerHTML = `
                    <td class="px-6 py-4 border-b text-xs">${new Date(s.completedAt).toLocaleString()}</td>
                    <td class="px-6 py-4 border-b text-xs font-mono">${s.id.slice(0,6)}</td>
                    <td class="px-6 py-4 border-b text-xs text-slate-500 max-w-xs truncate">${s.items.length} Items (${s.items.map(i=>i.name).join(', ')})</td>
                    <td class="px-6 py-4 border-b text-right font-bold">₱${s.total.toFixed(2)}</td>
                    <td class="px-6 py-4 border-b text-right">${statusBadge} <span class="text-xs text-slate-400 uppercase ml-1">${s.paymentMethod}</span></td>
                    <td class="px-6 py-4 border-b text-right">
                        <button onclick="printReceipt('${s.id}')" class="text-slate-400 hover:text-slate-800 mr-2"><i class="fas fa-print"></i></button>
                        ${currentRole === 'admin' ? `
                        <button onclick="adminEditTrans('${s.id}', ${s.total})" class="text-blue-400 hover:text-blue-600 mr-2"><i class="fas fa-edit"></i></button>
                        <button onclick="adminDeleteTrans('${s.id}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                        ` : ''}
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        window.adminEditTrans = (id, total) => {
            document.getElementById('edit-trans-id').value = id;
            document.getElementById('edit-trans-total').value = total;
            document.getElementById('modal-edit-trans').classList.remove('hidden');
        };

        window.saveTransEdit = async () => {
            const id = document.getElementById('edit-trans-id').value;
            const newTotal = parseFloat(document.getElementById('edit-trans-total').value);
            // DIRECT FIREBASE CALL
            try {
                await updateDoc(doc(db, "sales", id), { total: newTotal });
                closeModal('modal-edit-trans');
                showToast("Transaction Corrected", "success");
            } catch (e) { showToast("Error updating transaction", "error"); console.error(e); }
        };

        window.adminDeleteTrans = async (id) => {
            if (confirm("ADMIN WARNING: This will permanently remove this record from audit logs. Continue?")) {
                try {
                    await deleteDoc(doc(db, "sales", id));
                    showToast("Record Removed", "success");
                } catch(e) { showToast("Error deleting", "error"); console.error(e); }
            }
        };
        
        window.resetSalesData = async () => {
            if (confirm("CRITICAL ACTION: This will wipe ALL sales history. Are you absolutely sure?")) {
                const batch = writeBatch(db);
                salesHistory.forEach(s => batch.delete(doc(db, "sales", s.id)));
                await batch.commit();
                showToast("Database Reset Complete", "success");
            }
        };

        // --- MISC UTILS ---
        function checkPayables() {
            const now = new Date();
            const hasOverdue = salesHistory.some(s => {
                if (s.paymentMethod === 'payable' && s.paymentStatus === 'pending') {
                    const dueDate = new Date(s.payableDetails.dueDate);
                    return now > dueDate;
                }
                return false;
            });
            const alertBox = document.getElementById('payable-alert');
            if (hasOverdue) alertBox.classList.remove('hidden');
            else alertBox.classList.add('hidden');
        }

        window.printReceipt = (id) => {
            const order = activeOrders.find(o => o.id === id) || salesHistory.find(o => o.id === id);
            if (!order) return showToast("Order not found", "error");
            document.getElementById('receipt-date').textContent = new Date().toLocaleString();
            document.getElementById('receipt-id').textContent = order.id.slice(0, 8);
            document.getElementById('receipt-table').textContent = order.tableName;
            document.getElementById('receipt-staff').textContent = (order.staff || "N/A").split('@')[0];
            const tbody = document.getElementById('receipt-items');
            tbody.innerHTML = '';
            order.items.forEach(i => {
                const tr = document.createElement('tr');
                const finalPrice = i.price * i.qty * ((100 - (i.discount||0))/100);
                tr.innerHTML = `<td class="py-1">${i.name} ${i.discount>0 ? `(-${i.discount}%)` : ''}</td><td class="py-1 text-right">${i.qty}</td><td class="py-1 text-right">${finalPrice.toFixed(2)}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('receipt-total').textContent = '₱' + order.total.toFixed(2);
            const footer = document.getElementById('receipt-footer-msg');
            if (order.paymentMethod === 'payable') {
                footer.innerHTML = `CHARGED TO ACCOUNT: ${order.payableDetails.accountName}<br>DUE: ${new Date(order.payableDetails.dueDate).toLocaleDateString()}`;
            } else { footer.textContent = "Please come again!"; }
            window.print();
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        
        window.switchTab = (tabName) => {
            document.querySelectorAll('.content-tab').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.setAttribute('data-active', 'false'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            const navBtn = document.querySelector(`.nav-btn[data-target="${tabName}"]`);
            if (navBtn) navBtn.setAttribute('data-active', 'true');
            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('-translate-x-full');
                document.getElementById('sidebar-overlay').classList.add('hidden');
            }
            if(tabName === 'dashboard') updateDashboard();
        };

        window.switchRole = (role) => {
            currentRole = role;
            applyRoleUI();
            showToast(`Role Switched to ${role.toUpperCase()}`, 'info');
        };

        function applyRoleUI() {
            document.getElementById('user-role-display').textContent = currentRole;
            document.querySelectorAll('.nav-btn, .role-admin').forEach(el => el.classList.add('hidden')); 
            
            // Base Visibility
            document.querySelectorAll(`.nav-btn.role-${currentRole}`).forEach(el => el.classList.remove('hidden'));
            
            // Specific Admin Panels
            if (currentRole === 'admin') {
                document.querySelectorAll('.role-admin').forEach(el => el.classList.remove('hidden'));
            }
            
            // Oversee Specific
            if (currentRole === 'oversee') {
                // Ensure specific management buttons are visible if marked
                // (Already handled by class role-oversee on buttons)
            }
        }

        function startClock() {
            const clockEl = document.getElementById('kitchen-clock');
            clockInterval = setInterval(() => { if (clockEl) clockEl.textContent = new Date().toLocaleTimeString(); }, 1000);
        }

        window.showToast = (msg, type = 'info') => {
            const toast = document.getElementById('toast');
            const title = document.getElementById('toast-title');
            const message = document.getElementById('toast-message');
            const icon = document.getElementById('toast-icon');
            title.textContent = type === 'error' ? 'Error' : (type === 'success' ? 'Success' : 'Notification');
            message.textContent = msg;
            if (type === 'error') {
                icon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
                icon.className = 'mr-4 text-2xl text-red-600';
                toast.querySelector('div').className = "bg-white border-l-8 border-red-600 shadow-2xl rounded-r-lg p-4 flex items-center min-w-[300px]";
            } else if (type === 'success') {
                icon.innerHTML = '<i class="fas fa-check-circle"></i>';
                icon.className = 'mr-4 text-2xl text-green-600';
                toast.querySelector('div').className = "bg-white border-l-8 border-green-600 shadow-2xl rounded-r-lg p-4 flex items-center min-w-[300px]";
            } else {
                icon.innerHTML = '<i class="fas fa-info-circle"></i>';
                icon.className = 'mr-4 text-2xl text-blue-600';
                toast.querySelector('div').className = "bg-white border-l-8 border-blue-600 shadow-2xl rounded-r-lg p-4 flex items-center min-w-[300px]";
            }
            toast.classList.remove('translate-x-full');
            setTimeout(() => toast.classList.add('translate-x-full'), 3500);
        };

        function setLoading(isLoading) {
            const loader = document.getElementById('global-loader');
            if (isLoading) loader.classList.remove('hidden'); else loader.classList.add('hidden');
        }

        const toggleSidebar = () => {
            const sb = document.getElementById('sidebar');
            const ov = document.getElementById('sidebar-overlay');
            if (sb.classList.contains('-translate-x-full')) {
                sb.classList.remove('-translate-x-full');
                ov.classList.remove('hidden');
            } else {
                sb.classList.add('-translate-x-full');
                ov.classList.add('hidden');
            }
        };
        document.getElementById('mobile-menu-btn').onclick = toggleSidebar;
        document.getElementById('close-sidebar').onclick = toggleSidebar;
        document.getElementById('sidebar-overlay').onclick = toggleSidebar;

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            setLoading(true);
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, email, password).catch(error => {
                setLoading(false);
                showToast(error.message, 'error');
            });
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        const catSelectInv = document.getElementById('new-item-category');
        CATEGORIES.forEach(c => {
            const o = document.createElement('option');
            o.value = c;
            o.text = c;
            catSelectInv.add(o);
        });
        
    </script>
</body>
</html>
