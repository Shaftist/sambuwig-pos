<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sambuwig POS System</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Sidebar Transition */
        .sidebar-transition { transition: transform 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden flex flex-col">

    <!-- Notification Toast -->
    <div id="toast" class="fixed top-5 right-5 z-[60] transform translate-x-full transition-transform duration-300 bg-white border-l-4 border-blue-500 shadow-lg p-4 rounded flex items-center hidden">
        <div id="toast-icon" class="mr-3 text-blue-500"><i class="fas fa-info-circle"></i></div>
        <div>
            <h4 id="toast-title" class="font-bold text-sm">Notification</h4>
            <p id="toast-message" class="text-xs text-gray-600">Message goes here</p>
        </div>
    </div>

    <!-- APP CONTAINER -->
    <div id="app" class="flex-1 flex flex-col relative h-full">
        
        <!-- MOBILE HEADER -->
        <div class="md:hidden bg-gray-800 text-white p-4 flex justify-between items-center z-50 shadow-md">
            <div class="font-bold text-lg"><i class="fas fa-utensils text-orange-500 mr-2"></i>Sambuwig</div>
            <button id="mobile-menu-btn" class="focus:outline-none">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>

        <!-- LOGIN VIEW -->
        <div id="login-view" class="absolute inset-0 z-50 bg-gray-900 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-2xl p-8 max-w-md w-full">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold text-gray-800"><i class="fas fa-utensils text-orange-500 mr-2"></i>Sambuwig POS</h1>
                    <p class="text-gray-500 text-sm mt-2">Authorized Personnel Only</p>
                </div>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Email Address</label>
                        <input type="email" id="email" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-orange-500 focus:border-orange-500" placeholder="staff@restaurant.com" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="password" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-orange-500 focus:border-orange-500" placeholder="••••••••" required>
                    </div>
                    <div id="login-error" class="text-red-500 text-sm hidden"></div>
                    <button type="submit" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded transition duration-200">
                        Secure Login
                    </button>
                </form>
            </div>
        </div>

        <!-- MAIN LAYOUT -->
        <div id="main-layout" class="hidden h-full flex flex-row relative overflow-hidden">
            
            <!-- OVERLAY for Mobile Sidebar -->
            <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>

            <!-- SIDEBAR NAVIGATION -->
            <nav id="sidebar" class="bg-gray-800 text-white w-64 flex-shrink-0 flex flex-col justify-between absolute md:relative inset-y-0 left-0 transform -translate-x-full md:translate-x-0 z-40 sidebar-transition h-full shadow-2xl md:shadow-none">
                <div class="overflow-y-auto">
                    <div class="p-6 flex items-center justify-between font-bold text-xl border-b border-gray-700">
                        <span><i class="fas fa-utensils text-orange-500 mr-3"></i> Sambuwig</span>
                        <button class="md:hidden text-gray-400 hover:text-white" id="close-sidebar"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="p-4 space-y-2">
                        <button onclick="switchTab('dashboard')" class="nav-btn w-full text-left p-3 rounded hover:bg-gray-700 transition flex items-center bg-gray-700 text-orange-400" data-target="dashboard">
                            <i class="fas fa-chart-line w-6 text-center"></i> <span class="ml-2">Dashboard</span>
                        </button>
                        
                        <div class="pt-4 pb-2 px-3 text-xs font-bold text-gray-500 uppercase">Operations</div>
                        
                        <button onclick="switchTab('pos')" class="nav-btn w-full text-left p-3 rounded hover:bg-gray-700 transition flex items-center text-green-400 font-bold" data-target="pos">
                            <i class="fas fa-mobile-alt w-6 text-center"></i> <span class="ml-2">Take Order</span>
                        </button>
                        <button onclick="switchTab('kitchen')" class="nav-btn w-full text-left p-3 rounded hover:bg-gray-700 transition flex items-center text-yellow-400" data-target="kitchen">
                            <i class="fas fa-fire w-6 text-center"></i> <span class="ml-2">Kitchen View</span>
                            <span id="kitchen-badge" class="ml-auto bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                        </button>
                        <button onclick="switchTab('cashier')" class="nav-btn w-full text-left p-3 rounded hover:bg-gray-700 transition flex items-center text-blue-400" data-target="cashier">
                            <i class="fas fa-cash-register w-6 text-center"></i> <span class="ml-2">Cashier / Tables</span>
                            <span id="cashier-badge" class="ml-auto bg-blue-600 text-white text-xs font-bold px-2 py-0.5 rounded-full hidden">0</span>
                        </button>

                        <div class="pt-4 pb-2 px-3 text-xs font-bold text-gray-500 uppercase">Management</div>
                        
                        <button onclick="switchTab('reports')" class="nav-btn w-full text-left p-3 rounded hover:bg-gray-700 transition flex items-center" data-target="reports">
                            <i class="fas fa-file-invoice-dollar w-6 text-center"></i> <span class="ml-2">Monthly Reports</span>
                        </button>
                        <button onclick="switchTab('history')" class="nav-btn w-full text-left p-3 rounded hover:bg-gray-700 transition flex items-center" data-target="history">
                            <i class="fas fa-history w-6 text-center"></i> <span class="ml-2">History & Logs</span>
                        </button>
                        <button onclick="switchTab('inventory')" class="nav-btn w-full text-left p-3 rounded hover:bg-gray-700 transition flex items-center" data-target="inventory">
                            <i class="fas fa-boxes w-6 text-center"></i> <span class="ml-2">Inventory List</span>
                        </button>
                        <button onclick="switchTab('adjust')" class="nav-btn w-full text-left p-3 rounded hover:bg-gray-700 transition flex items-center" data-target="adjust">
                            <i class="fas fa-edit w-6 text-center"></i> <span class="ml-2">Adjust Stock</span>
                        </button>
                    </div>
                </div>
                <div class="p-4 border-t border-gray-700">
                    <div class="text-xs text-gray-400 mb-2 truncate">User: <span id="user-email-display"></span></div>
                    <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded text-sm">Logout</button>
                </div>
            </nav>

            <!-- CONTENT AREA -->
            <main class="flex-1 overflow-y-auto relative bg-gray-50 w-full">
                
                <!-- DASHBOARD TAB -->
                <div id="tab-dashboard" class="content-tab p-6 space-y-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Overview</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-green-500">
                            <div class="flex justify-between items-center">
                                <div><p class="text-gray-500 text-sm uppercase">Sales (This Month)</p><h3 class="text-3xl font-bold text-gray-800" id="total-sales">$0.00</h3></div>
                                <div class="text-green-500 bg-green-100 p-3 rounded-full"><i class="fas fa-dollar-sign"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-500 cursor-pointer" onclick="switchTab('adjust')">
                            <div class="flex justify-between items-center">
                                <div><p class="text-gray-500 text-sm uppercase">Low Stock Items</p><h3 class="text-3xl font-bold text-red-600" id="low-stock-count">0</h3></div>
                                <div class="text-red-500 bg-red-100 p-3 rounded-full"><i class="fas fa-exclamation-triangle"></i></div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow border-l-4 border-yellow-500">
                            <div class="flex justify-between items-center">
                                <div><p class="text-gray-500 text-sm uppercase">Dead Stock</p><h3 class="text-3xl font-bold text-yellow-600" id="dead-stock-count">0</h3></div>
                                <div class="text-yellow-500 bg-yellow-100 p-3 rounded-full"><i class="fas fa-hourglass-end"></i></div>
                            </div>
                        </div>
                    </div>
                    <!-- Admin Actions -->
                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-bold text-gray-700 mb-2">Admin Actions</h3>
                        <button onclick="resetSalesData()" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded shadow transition flex items-center">
                            <i class="fas fa-trash-alt mr-2"></i> Reset Sales History
                        </button>
                    </div>
                </div>

                <!-- REPORTS TAB (NEW) -->
                <div id="tab-reports" class="content-tab hidden p-4 md:p-6 fade-in h-full flex flex-col">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Monthly Reports</h2>
                    <div class="bg-white p-4 rounded shadow mb-6 flex flex-wrap gap-4 items-end">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Month</label>
                            <select id="report-month" class="border rounded p-2 text-sm w-32 bg-white">
                                <option value="0">January</option><option value="1">February</option><option value="2">March</option>
                                <option value="3">April</option><option value="4">May</option><option value="5">June</option>
                                <option value="6">July</option><option value="7">August</option><option value="8">September</option>
                                <option value="9">October</option><option value="10">November</option><option value="11">December</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Year</label>
                            <select id="report-year" class="border rounded p-2 text-sm w-24 bg-white">
                                <!-- JS will populate -->
                            </select>
                        </div>
                        <button onclick="generateReports()" class="bg-blue-600 text-white font-bold py-2 px-6 rounded hover:bg-blue-700 shadow flex items-center">
                            <i class="fas fa-sync-alt mr-2"></i> Generate Report
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 flex-1 overflow-hidden">
                        <!-- Sales Report Panel -->
                        <div class="bg-white rounded shadow flex flex-col h-full border border-gray-200">
                            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                                <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-coins text-green-500 mr-2"></i> Sales History</h3>
                                <button onclick="downloadSalesCSV()" class="text-green-600 text-sm font-bold hover:text-green-800 flex items-center bg-white border border-green-200 px-3 py-1 rounded shadow-sm">
                                    <i class="fas fa-file-csv mr-1"></i> Download CSV
                                </button>
                            </div>
                            <div class="flex-1 overflow-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-100 text-xs uppercase text-gray-500 sticky top-0">
                                        <tr><th class="p-3">Date</th><th class="p-3">Order/Items</th><th class="p-3 text-right">Total</th></tr>
                                    </thead>
                                    <tbody id="report-sales-body" class="divide-y divide-gray-100">
                                        <tr><td colspan="3" class="p-4 text-center text-gray-400 italic">Select date and click Generate</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="p-3 bg-gray-50 text-right font-bold border-t text-lg" id="report-sales-total">Total: $0.00</div>
                        </div>

                        <!-- Inventory Audit Report Panel -->
                        <div class="bg-white rounded shadow flex flex-col h-full border border-gray-200">
                            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                                <h3 class="font-bold text-gray-700 flex items-center"><i class="fas fa-warehouse text-orange-500 mr-2"></i> Inventory Log</h3>
                                <button onclick="downloadAuditCSV()" class="text-green-600 text-sm font-bold hover:text-green-800 flex items-center bg-white border border-green-200 px-3 py-1 rounded shadow-sm">
                                    <i class="fas fa-file-csv mr-1"></i> Download CSV
                                </button>
                            </div>
                            <div class="flex-1 overflow-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="bg-gray-100 text-xs uppercase text-gray-500 sticky top-0">
                                        <tr><th class="p-3">Date</th><th class="p-3">Action</th><th class="p-3">Description</th></tr>
                                    </thead>
                                    <tbody id="report-audit-body" class="divide-y divide-gray-100">
                                        <tr><td colspan="3" class="p-4 text-center text-gray-400 italic">Select date and click Generate</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- KITCHEN VIEW TAB -->
                <div id="tab-kitchen" class="content-tab hidden p-4 md:p-6 fade-in h-full flex flex-col">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-fire text-orange-500 mr-2"></i> Kitchen Display System
                    </h2>
                    <div id="kitchen-orders-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 overflow-y-auto pb-20">
                        <div class="text-gray-500 italic col-span-full text-center mt-10">No pending orders.</div>
                    </div>
                </div>

                <!-- CASHIER VIEW TAB -->
                <div id="tab-cashier" class="content-tab hidden p-4 md:p-6 fade-in h-full flex flex-col">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-cash-register text-blue-500 mr-2"></i> Cashier & Active Tables
                    </h2>
                    <div id="cashier-orders-list" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 overflow-y-auto pb-20">
                         <div class="text-gray-500 italic col-span-full text-center mt-10">No active tables.</div>
                    </div>
                </div>

                <!-- POS TAB -->
                <div id="tab-pos" class="content-tab hidden h-full flex flex-col md:flex-row fade-in overflow-hidden">
                    <div class="flex-1 overflow-y-auto p-4 bg-gray-200">
                        <div class="mb-4 overflow-x-auto whitespace-nowrap pb-2 flex" id="pos-categories">
                            <button onclick="filterPos('All')" class="px-4 py-2 bg-gray-800 text-white rounded-full text-sm mr-2 shadow flex-shrink-0">All</button>
                            <button onclick="filterPos('Main')" class="px-4 py-2 bg-white text-gray-800 rounded-full text-sm mr-2 shadow hover:bg-gray-100 flex-shrink-0">Main</button>
                            <button onclick="filterPos('Appetizer')" class="px-4 py-2 bg-white text-gray-800 rounded-full text-sm mr-2 shadow hover:bg-gray-100 flex-shrink-0">Appetizers</button>
                            <button onclick="filterPos('Beverage')" class="px-4 py-2 bg-white text-gray-800 rounded-full text-sm mr-2 shadow hover:bg-gray-100 flex-shrink-0">Beverages</button>
                            <button onclick="filterPos('Dessert')" class="px-4 py-2 bg-white text-gray-800 rounded-full text-sm mr-2 shadow hover:bg-gray-100 flex-shrink-0">Desserts</button>
                        </div>
                        <div id="pos-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4 pb-20 md:pb-4">
                            <!-- Items -->
                        </div>
                    </div>
                    <div class="w-full md:w-96 bg-white shadow-xl flex flex-col h-1/2 md:h-full border-t md:border-l border-gray-300">
                        <div class="p-4 bg-gray-50 border-b border-gray-200">
                            <h3 class="font-bold text-lg">New Order</h3>
                            <input type="text" id="table-number" placeholder="Enter Table No." class="mt-2 w-full p-2 border rounded text-lg font-bold text-center bg-yellow-50 focus:ring-2 focus:ring-yellow-400 outline-none" autocomplete="off">
                        </div>
                        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3">
                            <div class="text-center text-gray-400 mt-10 italic">Cart is empty</div>
                        </div>
                        <div class="p-4 bg-gray-50 border-t border-gray-200">
                            <div class="flex justify-between mb-2 text-xl font-bold">
                                <span>Total</span>
                                <span id="cart-final-total">$0.00</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="clearCart()" class="w-1/3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 rounded-lg">Clear</button>
                                <button id="btn-process-order" class="w-2/3 bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 rounded-lg shadow-lg flex justify-center items-center">
                                    Send to Kitchen <i class="fas fa-arrow-right ml-2"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HISTORY TAB -->
                <div id="tab-history" class="content-tab hidden p-4 md:p-6 fade-in h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">History & Logs</h2>
                        <input type="text" id="history-search" placeholder="Search..." class="outline-none text-sm w-full md:w-64 p-2 border rounded">
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden flex-1 overflow-x-auto">
                        <table class="min-w-full leading-normal">
                            <thead>
                                <tr>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Date</th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Type</th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Details</th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase">Amount</th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- INVENTORY TAB -->
                <div id="tab-inventory" class="content-tab hidden p-4 md:p-6 fade-in h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">Inventory</h2>
                        <input type="text" id="inventory-search" placeholder="Search..." class="outline-none text-sm w-full md:w-64 p-2 border rounded">
                    </div>
                    <div class="bg-white rounded-lg shadow overflow-hidden flex-1 overflow-x-auto">
                        <table class="min-w-full leading-normal">
                            <thead>
                                <tr>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Item</th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-left text-xs font-semibold text-gray-600 uppercase">Cat</th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-center text-xs font-semibold text-gray-600 uppercase">Stock</th>
                                    <th class="px-5 py-3 border-b-2 border-gray-200 bg-gray-100 text-right text-xs font-semibold text-gray-600 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="inventory-table-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- ADJUST TAB -->
                <div id="tab-adjust" class="content-tab hidden p-4 md:p-6 fade-in">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Inventory Management</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="font-bold text-gray-700 mb-4 pb-2 border-b">Add New Item</h3>
                            <form id="add-item-form" class="space-y-4">
                                <input type="text" id="new-item-name" class="w-full border rounded p-2 text-sm" placeholder="Item Name" required>
                                <select id="new-item-category" class="w-full border rounded p-2 text-sm"><option value="Main">Main</option><option value="Appetizer">Appetizer</option><option value="Beverage">Beverage</option><option value="Dessert">Dessert</option></select>
                                <div class="grid grid-cols-2 gap-4">
                                    <input type="number" step="0.01" id="new-item-price" class="w-full border rounded p-2 text-sm" placeholder="Price" required>
                                    <input type="number" id="new-item-stock" class="w-full border rounded p-2 text-sm" placeholder="Stock" required>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded">Add Item</button>
                            </form>
                        </div>
                        <div class="bg-white p-6 rounded-lg shadow">
                            <h3 class="font-bold text-gray-700 mb-4 pb-2 border-b">Quick Adjust</h3>
                            <select id="adjust-item-select" class="w-full border rounded p-2 text-sm mb-4"><option>Loading...</option></select>
                            <input type="number" id="adjust-amount" class="w-full border rounded p-2 text-sm mb-4" placeholder="Amount to add (negative to remove)">
                            <button id="btn-update-stock" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded">Update Stock</button>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, updateDoc, doc, runTransaction, query, where, orderBy, getDocs, setDoc, deleteDoc, writeBatch, limit } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyB5L9S3_diMaKQ7IyXEnyhEuWOHz8-QTvY",
            authDomain: "my-pos-system-3683a.firebaseapp.com",
            projectId: "my-pos-system-3683a",
            storageBucket: "my-pos-system-3683a.firebasestorage.app",
            messagingSenderId: "1040426979758",
            appId: "1:1040426979758:web:da01b11782d68dac86f83f",
            measurementId: "G-19J5SSFD9H"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let inventoryData = [];
        let salesData = [];
        let auditData = [];
        let activeOrdersData = [];
        let cart = {}; // { itemId: { quantity: 1, discount: 0, item: {...} } }
        const ADMIN_EMAIL = "admin@smbwg.com";

        // Report Data State
        let reportSalesData = [];
        let reportAuditData = [];

        // --- MOBILE UI LOGIC ---
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const closeSidebarBtn = document.getElementById('close-sidebar');

        function toggleSidebar() {
            sidebar.classList.toggle('-translate-x-full');
            overlay.classList.toggle('hidden');
        }

        mobileMenuBtn.addEventListener('click', toggleSidebar);
        overlay.addEventListener('click', toggleSidebar);
        closeSidebarBtn.addEventListener('click', toggleSidebar);

        // Populate Report Year
        const currentYear = new Date().getFullYear();
        const yearSelect = document.getElementById('report-year');
        for(let i=currentYear; i>=currentYear-5; i--) {
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = i;
            yearSelect.appendChild(opt);
        }
        document.getElementById('report-month').value = new Date().getMonth();

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('user-email-display').textContent = user.email;
                subscribeToInventory();
                subscribeToSales();
                subscribeToAuditLogs();
                subscribeToActiveOrders();
                document.getElementById('login-view').classList.add('hidden');
                document.getElementById('main-layout').classList.remove('hidden');
                showToast('Welcome back!', 'success');
            } else {
                document.getElementById('login-view').classList.remove('hidden');
                document.getElementById('main-layout').classList.add('hidden');
            }
        });

        document.getElementById('login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
                .catch(err => showToast(err.message, "error"));
        });
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

        // --- DATA SYNC ---
        function subscribeToInventory() {
            onSnapshot(query(collection(db, "inventory"), orderBy("name")), (snap) => {
                inventoryData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderInventoryTable();
                populateAdjustSelect();
                renderPosGrid();
                updateDashboardStats(); // Update low stock counts
            });
        }
        function subscribeToSales() {
            onSnapshot(query(collection(db, "sales"), orderBy("timestamp", "desc"), limit(100)), (snap) => {
                salesData = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'sale' }));
                renderHistoryTable();
                updateDashboardStats();
            });
        }
        function subscribeToAuditLogs() {
            onSnapshot(query(collection(db, "audit_logs"), orderBy("timestamp", "desc"), limit(100)), (snap) => {
                auditData = snap.docs.map(d => ({ id: d.id, ...d.data(), type: 'audit' }));
                renderHistoryTable();
            });
        }
        function subscribeToActiveOrders() {
            onSnapshot(query(collection(db, "active_orders"), orderBy("timestamp", "asc")), (snap) => {
                activeOrdersData = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderKitchenView();
                renderCashierView();
                
                // Update Badges
                const kitchenCount = activeOrdersData.filter(o => o.status === 'pending').length;
                const cashierCount = activeOrdersData.filter(o => o.status === 'served').length;
                
                const kBadge = document.getElementById('kitchen-badge');
                const cBadge = document.getElementById('cashier-badge');
                
                kBadge.textContent = kitchenCount;
                kBadge.classList.toggle('hidden', kitchenCount === 0);
                cBadge.textContent = cashierCount;
                cBadge.classList.toggle('hidden', cashierCount === 0);
            });
        }

        // --- REPORTING LOGIC ---
        window.generateReports = async () => {
            const m = parseInt(document.getElementById('report-month').value);
            const y = parseInt(document.getElementById('report-year').value);
            
            // Construct date range
            const start = new Date(y, m, 1);
            const end = new Date(y, m + 1, 0, 23, 59, 59);

            const startStr = start.toISOString();
            const endStr = end.toISOString();

            // Fetch Sales
            const salesQ = query(collection(db, "sales"), where("timestamp", ">=", startStr), where("timestamp", "<=", endStr));
            const salesSnap = await getDocs(salesQ);
            reportSalesData = salesSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Fetch Audit Logs (Inventory Changes)
            const auditQ = query(collection(db, "audit_logs"), where("timestamp", ">=", startStr), where("timestamp", "<=", endStr));
            const auditSnap = await getDocs(auditQ);
            reportAuditData = auditSnap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

            // Render Sales Report
            const sBody = document.getElementById('report-sales-body');
            sBody.innerHTML = '';
            let total = 0;
            if(reportSalesData.length === 0) sBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No sales found for this period.</td></tr>';
            
            reportSalesData.forEach(s => {
                total += s.total || 0;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 text-gray-600">${new Date(s.timestamp).toLocaleDateString()} ${new Date(s.timestamp).toLocaleTimeString()}</td>
                    <td class="p-3 text-gray-800 font-medium">${s.items ? s.items.length : 0} Items (Table ${s.tableNumber})</td>
                    <td class="p-3 text-right font-bold">$${(s.total||0).toFixed(2)}</td>
                `;
                sBody.appendChild(tr);
            });
            document.getElementById('report-sales-total').textContent = `Total: $${total.toFixed(2)}`;

            // Render Audit Report
            const aBody = document.getElementById('report-audit-body');
            aBody.innerHTML = '';
            if(reportAuditData.length === 0) aBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">No inventory changes found.</td></tr>';

            reportAuditData.forEach(a => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 text-gray-600">${new Date(a.timestamp).toLocaleDateString()}</td>
                    <td class="p-3"><span class="uppercase text-xs font-bold px-2 py-1 rounded bg-gray-100">${a.action}</span></td>
                    <td class="p-3 text-sm text-gray-700">${a.description}</td>
                `;
                aBody.appendChild(tr);
            });

            showToast(`Report Generated: ${reportSalesData.length} Sales, ${reportAuditData.length} Logs`, "success");
        };

        window.downloadSalesCSV = () => {
            if(reportSalesData.length === 0) return showToast("No data to download", "error");
            
            let csv = "Date,Time,Table,Items,Total,Staff\n";
            reportSalesData.forEach(row => {
                const d = new Date(row.timestamp);
                const itemsStr = row.items ? row.items.map(i => `${i.qty}x ${i.name}`).join(';') : '';
                // Escape quotes in itemsStr if necessary
                csv += `${d.toLocaleDateString()},${d.toLocaleTimeString()},${row.tableNumber},"${itemsStr}",${(row.total||0).toFixed(2)},${row.staffEmail}\n`;
            });

            downloadCSV(csv, `Sales_Report_${document.getElementById('report-month').value}_${document.getElementById('report-year').value}.csv`);
        };

        window.downloadAuditCSV = () => {
            if(reportAuditData.length === 0) return showToast("No data to download", "error");

            let csv = "Date,Time,Action,Description,User\n";
            reportAuditData.forEach(row => {
                const d = new Date(row.timestamp);
                csv += `${d.toLocaleDateString()},${d.toLocaleTimeString()},${row.action},"${row.description.replace(/"/g, '""')}",${row.staffEmail}\n`;
            });

            downloadCSV(csv, `Inventory_Log_${document.getElementById('report-month').value}_${document.getElementById('report-year').value}.csv`);
        };

        function downloadCSV(csvContent, fileName) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", fileName);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // --- ACTIVE ORDER VIEWS (KITCHEN & CASHIER) ---

        function renderKitchenView() {
            const container = document.getElementById('kitchen-orders-list');
            const pendingOrders = activeOrdersData.filter(o => o.status === 'pending');
            container.innerHTML = '';

            if(pendingOrders.length === 0) {
                container.innerHTML = '<div class="text-gray-500 italic col-span-full text-center mt-10">No pending orders. Kitchen is clear!</div>';
                return;
            }

            pendingOrders.forEach(order => {
                const elapsedMins = Math.floor((Date.now() - new Date(order.timestamp).getTime()) / 60000);
                const card = document.createElement('div');
                card.className = "bg-white rounded shadow-md border-l-4 border-yellow-400 flex flex-col";
                card.innerHTML = `
                    <div class="p-4 border-b bg-yellow-50 flex justify-between items-center">
                        <div>
                            <span class="font-bold text-lg">Table ${order.tableNumber}</span>
                            <div class="text-xs text-gray-500">${new Date(order.timestamp).toLocaleTimeString()} (${elapsedMins}m ago)</div>
                        </div>
                        <i class="fas fa-clock text-yellow-400 text-xl"></i>
                    </div>
                    <div class="p-4 flex-1 overflow-y-auto max-h-48">
                        <ul class="space-y-2">
                            ${order.items.map(item => `
                                <li class="flex justify-between border-b pb-1">
                                    <span class="font-bold">${item.qty}x ${item.name}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                    <div class="p-4 bg-gray-50 mt-auto">
                        <button onclick="markOrderServed('${order.id}')" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 rounded shadow">
                            Mark as Served <i class="fas fa-check ml-1"></i>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.markOrderServed = async (orderId) => {
            try {
                await updateDoc(doc(db, "active_orders", orderId), { status: 'served' });
                showToast("Order marked as served!", "success");
            } catch(e) { showToast(e.message, "error"); }
        };

        function renderCashierView() {
            const container = document.getElementById('cashier-orders-list');
            const servedOrders = activeOrdersData.filter(o => o.status === 'served');
            container.innerHTML = '';

            if(servedOrders.length === 0) {
                container.innerHTML = '<div class="text-gray-500 italic col-span-full text-center mt-10">No active tables waiting for payment.</div>';
                return;
            }

            servedOrders.forEach(order => {
                const card = document.createElement('div');
                card.className = "bg-white rounded shadow-md border-l-4 border-blue-500 flex flex-col";
                card.innerHTML = `
                    <div class="p-4 border-b bg-blue-50 flex justify-between items-center">
                        <span class="font-bold text-lg">Table ${order.tableNumber}</span>
                        <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded font-bold">Unpaid</span>
                    </div>
                    <div class="p-4 flex-1">
                        <ul class="space-y-1 text-sm text-gray-600 mb-4">
                            ${order.items.map(item => `
                                <li class="flex justify-between">
                                    <span>${item.qty}x ${item.name}</span>
                                    <span>$${(item.price * item.qty).toFixed(2)}</span>
                                </li>
                            `).join('')}
                        </ul>
                        <div class="flex justify-between font-bold text-xl text-gray-800 border-t pt-2">
                            <span>Total:</span>
                            <span>$${order.total.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 mt-auto grid grid-cols-2 gap-2">
                        <button onclick="deleteActiveOrder('${order.id}')" class="bg-red-100 hover:bg-red-200 text-red-600 font-bold py-2 rounded">Cancel</button>
                        <button onclick="finalizePayment('${order.id}')" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded shadow">
                            Pay & Close
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        window.finalizePayment = async (orderId) => {
            if(!confirm("Finalize payment and close table?")) return;
            const order = activeOrdersData.find(o => o.id === orderId);
            if(!order) return;

            try {
                // Add to History (Sales)
                await addDoc(collection(db, "sales"), {
                    ...order,
                    completedAt: new Date().toISOString(),
                    type: 'sale_completed' // Distinguish from the raw object
                });
                // Remove from Active Orders
                await deleteDoc(doc(db, "active_orders", orderId));
                showToast("Payment successful! Table closed.", "success");
            } catch(e) { showToast(e.message, "error"); }
        };

        window.deleteActiveOrder = async (orderId) => {
            if(!confirm("Cancel this order? Stock will NOT be automatically returned in this version (Manual adjust required).")) return;
            // Note: In a full production app, you'd increment inventory back here.
            try {
                await deleteDoc(doc(db, "active_orders", orderId));
                showToast("Order cancelled.", "success");
            } catch(e) { showToast(e.message, "error"); }
        };

        // --- POS TRANSACTION FIX ---

        document.getElementById('btn-process-order').addEventListener('click', async () => {
            const tableNum = document.getElementById('table-number').value.trim();
            const items = Object.values(cart);
            
            if (items.length === 0) return showToast("Cart is empty", "error");
            if (!tableNum) return showToast("Please enter Table Number", "error");

            const btn = document.getElementById('btn-process-order');
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<div class="loader border-white"></div>';
            btn.disabled = true;

            try {
                // FIXED TRANSACTION LOGIC: Split Reads and Writes
                await runTransaction(db, async (transaction) => {
                    const itemRefs = [];
                    // 1. READ PHASE
                    for (const cartItem of items) {
                        const ref = doc(db, "inventory", cartItem.item.id);
                        const snap = await transaction.get(ref);
                        if (!snap.exists()) throw `Item ${cartItem.item.name} not found!`;
                        itemRefs.push({ ref, snap, cartItem });
                    }

                    // 2. LOGIC PHASE (Validation)
                    for (const { snap, cartItem } of itemRefs) {
                        const currentStock = snap.data().stock;
                        if (currentStock < cartItem.quantity) {
                            throw `Not enough stock for ${cartItem.item.name}. Available: ${currentStock}`;
                        }
                    }

                    // 3. WRITE PHASE
                    // A. Deduct Inventory
                    for (const { ref, snap, cartItem } of itemRefs) {
                        const newStock = snap.data().stock - cartItem.quantity;
                        transaction.update(ref, { 
                            stock: newStock,
                            lastSold: new Date().toISOString()
                        });
                    }

                    // B. Create Active Order
                    const total = items.reduce((sum, i) => {
                        const discount = i.discount || 0;
                        return sum + (i.quantity * i.item.price * ((100 - discount) / 100));
                    }, 0);

                    const orderRef = doc(collection(db, "active_orders"));
                    transaction.set(orderRef, {
                        tableNumber: tableNum,
                        status: 'pending', // Step 1: Pending
                        items: items.map(i => ({ 
                            name: i.item.name, 
                            qty: i.quantity, 
                            price: i.item.price, 
                            id: i.item.id,
                            discount: i.discount || 0
                        })),
                        total: total,
                        timestamp: new Date().toISOString(),
                        staffEmail: currentUser.email
                    });
                });

                cart = {};
                renderCart();
                document.getElementById('table-number').value = '';
                showToast("Order sent to Kitchen!", "success");
            } catch (e) {
                console.error(e);
                showToast(e.toString().replace("Error:", ""), "error");
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        });

        // --- UI HELPERS ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.content-tab').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('bg-gray-700', 'text-orange-400'));
            
            document.getElementById('tab-' + tabId).classList.remove('hidden');
            const navBtn = document.querySelector(`button[data-target="${tabId}"]`);
            if(navBtn) navBtn.classList.add('bg-gray-700', 'text-orange-400');
            
            // Auto-close sidebar on mobile selection
            if(window.innerWidth < 768) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        };

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            const title = document.getElementById('toast-title');
            const message = document.getElementById('toast-message');
            const icon = document.getElementById('toast-icon');

            toast.classList.remove('hidden', 'translate-x-full', 'border-blue-500', 'border-red-500', 'border-green-500');
            
            if(type === 'error') {
                toast.classList.add('border-red-500');
                icon.className = 'mr-3 text-red-500 fas fa-exclamation-circle';
                title.innerText = "Error";
            } else if (type === 'success') {
                toast.classList.add('border-green-500');
                icon.className = 'mr-3 text-green-500 fas fa-check-circle';
                title.innerText = "Success";
            } else {
                toast.classList.add('border-blue-500');
                icon.className = 'mr-3 text-blue-500 fas fa-info-circle';
                title.innerText = "Info";
            }

            message.innerText = msg;
            setTimeout(() => toast.classList.add('translate-x-full'), 3000);
        }

        // --- POS FUNCTIONS ---
        let posCategoryFilter = 'All';
        window.filterPos = (cat) => {
            posCategoryFilter = cat;
            document.querySelectorAll('#pos-categories button').forEach(b => {
                b.className = b.innerText === cat || (cat==='All' && b.innerText==='All') 
                    ? "px-4 py-2 bg-gray-800 text-white rounded-full text-sm mr-2 shadow flex-shrink-0" 
                    : "px-4 py-2 bg-white text-gray-800 rounded-full text-sm mr-2 shadow hover:bg-gray-100 flex-shrink-0";
            });
            renderPosGrid();
        };

        function renderPosGrid() {
            const grid = document.getElementById('pos-grid');
            grid.innerHTML = '';
            inventoryData.filter(i => posCategoryFilter === 'All' || i.category === posCategoryFilter).forEach(item => {
                const card = document.createElement('div');
                card.className = `bg-white p-4 rounded-lg shadow cursor-pointer transition transform hover:scale-105 active:scale-95 border-l-4 ${item.stock <= 0 ? 'border-red-500 opacity-60' : 'border-green-500'}`;
                if (item.stock > 0) card.onclick = () => addToCart(item);
                card.innerHTML = `
                    <div class="flex justify-between items-start"><h4 class="font-bold text-gray-800 leading-tight h-10 overflow-hidden">${item.name}</h4><span class="text-xs font-bold bg-gray-100 px-2 py-1 rounded">$${item.price}</span></div>
                    <p class="text-xs text-gray-500 mt-2">Stock: ${item.stock}</p>
                `;
                grid.appendChild(card);
            });
        }

        function addToCart(item) {
            cart[item.id] = cart[item.id] ? { ...cart[item.id], quantity: cart[item.id].quantity + 1 } : { quantity: 1, item: item, discount: 0 };
            renderCart();
        }
        window.removeFromCart = (id) => { delete cart[id]; renderCart(); };
        window.clearCart = () => { cart = {}; renderCart(); };

        window.applyDiscount = (itemId) => {
            const password = prompt("Enter Password (01 Manager, 05 PWD/Senior):");
            if (password === "05") { cart[itemId].discount = 20; showToast("20% Discount Applied", "success"); }
            else if (password === "01") {
                const r = parseFloat(prompt("Enter % (0-100):"));
                if (!isNaN(r) && r >= 0 && r <= 100) { cart[itemId].discount = r; showToast(`${r}% Discount Applied`, "success"); }
            } else showToast("Invalid Password", "error");
            renderCart();
        };

        function renderCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let total = 0;
            const items = Object.values(cart);
            if (items.length === 0) container.innerHTML = '<div class="text-center text-gray-400 mt-10 italic">Cart is empty</div>';
            else items.forEach(i => {
                const price = i.item.price * ((100 - i.discount) / 100);
                total += i.quantity * price;
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-white border rounded p-2 shadow-sm";
                div.innerHTML = `
                    <div class="flex-1"><div class="font-bold text-sm">${i.item.name}</div><div class="text-xs text-gray-500">${i.discount>0 ? `<span class="text-red-500">-${i.discount}%</span> ` : ''}$${price.toFixed(2)} x ${i.quantity}</div></div>
                    <div class="font-bold text-gray-700 mr-2">$${(i.quantity * price).toFixed(2)}</div>
                    <div class="flex space-x-1"><button onclick="applyDiscount('${i.item.id}')" class="text-blue-500 p-1"><i class="fas fa-tag"></i></button><button onclick="removeFromCart('${i.item.id}')" class="text-red-500 p-1"><i class="fas fa-trash"></i></button></div>
                `;
                container.appendChild(div);
            });
            document.getElementById('cart-final-total').textContent = '$' + total.toFixed(2);
        }

        // --- DASHBOARD & INVENTORY HELPERS ---
        function renderInventoryTable() {
            const tbody = document.getElementById('inventory-table-body');
            const term = document.getElementById('inventory-search').value.toLowerCase();
            tbody.innerHTML = '';
            inventoryData.filter(i => i.name.toLowerCase().includes(term)).forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                tr.innerHTML = `<td class="px-5 py-4 border-b bg-white text-sm font-bold">${item.name}</td><td class="px-5 py-4 border-b bg-white text-sm">${item.category}</td><td class="px-5 py-4 border-b bg-white text-sm text-center font-bold ${item.stock < (item.lowStockThreshold || 10) ? 'text-red-600' : 'text-green-600'}">${item.stock}</td><td class="px-5 py-4 border-b bg-white text-sm text-right"><button onclick="deleteInventoryItem('${item.id}', '${item.name}')" class="text-red-500 hover:text-red-700"><i class="fas fa-trash"></i></button></td>`;
                tbody.appendChild(tr);
            });
        }
        document.getElementById('inventory-search').addEventListener('input', renderInventoryTable);
        
        function renderHistoryTable() {
            const tbody = document.getElementById('history-table-body');
            const term = document.getElementById('history-search').value.toLowerCase();
            tbody.innerHTML = '';
            [...salesData, ...auditData].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).filter(r => JSON.stringify(r).toLowerCase().includes(term)).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="px-5 py-4 border-b bg-white text-xs">${new Date(r.timestamp).toLocaleString()}</td><td class="px-5 py-4 border-b bg-white"><span class="bg-${r.type==='sale'?'green':(r.action==='delete'?'red':'blue')}-100 text-${r.type==='sale'?'green':(r.action==='delete'?'red':'blue')}-800 text-xs px-2 py-1 rounded uppercase">${r.type==='sale'?'Sale':r.action}</span></td><td class="px-5 py-4 border-b bg-white text-sm truncate max-w-xs">${r.type==='sale' ? r.items.map(i=>`${i.qty}x ${i.name}`).join(', ') : r.description}</td><td class="px-5 py-4 border-b bg-white text-right text-sm font-bold">${r.total ? '$'+r.total.toFixed(2) : '-'}</td><td class="px-5 py-4 border-b bg-white text-right"><button class="text-red-400 hover:text-red-600 text-xs" onclick="deleteHistoryRecord('${r.id}', '${r.type==='sale'?'sales':'audit_logs'}')">Del</button></td>`;
                tbody.appendChild(tr);
            });
        }
        document.getElementById('history-search').addEventListener('input', renderHistoryTable);

        // ... Existing Admin/Inventory Logic ...
        window.deleteInventoryItem = async (id, name) => { if(confirm("Delete item?")) { await deleteDoc(doc(db, "inventory", id)); await addDoc(collection(db, "audit_logs"), { action: 'delete', description: `Deleted ${name}`, timestamp: new Date().toISOString() }); } };
        window.deleteHistoryRecord = async (id, col) => { if(currentUser.email===ADMIN_EMAIL && confirm("Admin Delete?")) { await deleteDoc(doc(db, col, id)); } };
        window.resetSalesData = async () => { if(prompt("Password")==="090408" && confirm("Reset All History?")) { const q=query(collection(db,"sales")); const snap=await getDocs(q); const b=writeBatch(db); snap.forEach(d=>b.delete(d.ref)); await b.commit(); showToast("Reset Complete", "success"); } };
        
        function updateDashboardStats() {
            // (Simplified from previous version for brevity)
            const total = salesData.reduce((s, r) => s + (r.total||0), 0);
            document.getElementById('total-sales').textContent = '$'+total.toFixed(2);
            document.getElementById('low-stock-count').textContent = inventoryData.filter(i => i.stock < (i.lowStockThreshold||10)).length;
        }

        // Add/Adjust Inventory UI Bindings
        document.getElementById('add-item-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                const name = document.getElementById('new-item-name').value;
                await addDoc(collection(db, "inventory"), { name, category: document.getElementById('new-item-category').value, price: parseFloat(document.getElementById('new-item-price').value), stock: parseInt(document.getElementById('new-item-stock').value), lowStockThreshold: 10, lastSold: new Date().toISOString() });
                await addDoc(collection(db, "audit_logs"), { action: 'add', description: `Added ${name}`, timestamp: new Date().toISOString() });
                e.target.reset(); showToast("Item Added", "success");
            } catch(e) { showToast(e.message, "error"); }
        });

        function populateAdjustSelect() {
            const s = document.getElementById('adjust-item-select'); s.innerHTML = '<option>Select Item...</option>';
            inventoryData.forEach(i => { const o = document.createElement('option'); o.value = i.id; o.text = `${i.name} (${i.stock})`; s.appendChild(o); });
        }
        document.getElementById('btn-update-stock').addEventListener('click', async () => {
            const id = document.getElementById('adjust-item-select').value;
            const amt = parseInt(document.getElementById('adjust-amount').value);
            if(id && !isNaN(amt)) {
                await runTransaction(db, async (t) => { const r=doc(db,"inventory",id); const s=await t.get(r); t.update(r, { stock: s.data().stock+amt }); });
                await addDoc(collection(db, "audit_logs"), { action: 'adjust', description: `Adjusted stock by ${amt}`, timestamp: new Date().toISOString() });
                showToast("Updated", "success");
            }
        });
    </script>
</body>
</html>
