<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sambuwig Online Order</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .cart-bounce { animation: bounce 0.5s; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    </style>
</head>
<body class="bg-orange-50 text-gray-800 flex flex-col min-h-screen">

    <!-- HEADER -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <div class="bg-orange-600 text-white p-2 rounded-lg mr-3">
                    <i class="fas fa-hamburger text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-xl leading-tight text-orange-900">Sambuwig</h1>
                    <p class="text-xs text-orange-600 font-semibold">Online Ordering</p>
                </div>
            </div>
            <button onclick="toggleCart()" class="relative p-2 text-orange-900 hover:text-orange-600 transition">
                <i class="fas fa-shopping-cart text-2xl"></i>
                <span id="cart-badge" class="absolute top-0 right-0 bg-red-600 text-white text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center hidden transform scale-0 transition-transform duration-200">0</span>
            </button>
        </div>
    </header>

    <!-- HERO -->
    <div class="bg-orange-600 text-white text-center py-10 px-4 mb-6 shadow-inner">
        <h2 class="text-3xl font-bold mb-2">Craving something delicious?</h2>
        <p class="text-orange-100 max-w-md mx-auto">Order now and we'll deliver straight to your doorstep. Cash or GCash on Delivery available!</p>
    </div>

    <!-- MAIN CONTENT -->
    <main class="container mx-auto px-4 flex-1 pb-20">
        
        <!-- CATEGORIES -->
        <div class="flex overflow-x-auto space-x-3 pb-6 no-scrollbar" id="categories">
            <button onclick="filter('All')" class="cat-btn px-6 py-2 bg-orange-900 text-white rounded-full font-bold shadow-lg transform transition hover:scale-105 whitespace-nowrap">All</button>
            <button onclick="filter('Main')" class="cat-btn px-6 py-2 bg-white text-gray-700 rounded-full font-bold shadow hover:bg-orange-100 whitespace-nowrap">Main Course</button>
            <button onclick="filter('Appetizer')" class="cat-btn px-6 py-2 bg-white text-gray-700 rounded-full font-bold shadow hover:bg-orange-100 whitespace-nowrap">Appetizers</button>
            <button onclick="filter('Beverage')" class="cat-btn px-6 py-2 bg-white text-gray-700 rounded-full font-bold shadow hover:bg-orange-100 whitespace-nowrap">Beverages</button>
            <button onclick="filter('Dessert')" class="cat-btn px-6 py-2 bg-white text-gray-700 rounded-full font-bold shadow hover:bg-orange-100 whitespace-nowrap">Desserts</button>
        </div>

        <!-- PRODUCT GRID -->
        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            <!-- Items injected here -->
            <div class="col-span-full text-center py-12 text-gray-400">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p>Loading Menu...</p>
            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="bg-gray-800 text-gray-400 py-8 text-center text-sm">
        <p>&copy; 2024 Sambuwig Restaurant. All rights reserved.</p>
        <p class="mt-2"><i class="fas fa-phone mr-2"></i> (02) 8888-1234</p>
    </footer>

    <!-- CART MODAL -->
    <div id="cart-modal" class="fixed inset-0 z-50 bg-black bg-opacity-60 hidden flex justify-end">
        <div class="bg-white w-full max-w-md h-full shadow-2xl flex flex-col transform translate-x-full transition-transform duration-300" id="cart-panel">
            <div class="p-4 bg-orange-50 border-b flex justify-between items-center">
                <h2 class="font-bold text-xl text-gray-800"><i class="fas fa-shopping-bag text-orange-600 mr-2"></i>Your Bag</h2>
                <button onclick="toggleCart()" class="text-gray-500 hover:text-gray-800"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-4">
                <div class="text-center text-gray-400 mt-20 flex flex-col items-center">
                    <i class="fas fa-shopping-basket text-6xl mb-4 opacity-20"></i>
                    <p>Your bag is empty.</p>
                    <button onclick="toggleCart()" class="mt-4 text-orange-600 font-bold hover:underline">Start Ordering</button>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50">
                <div class="flex justify-between text-lg font-bold mb-4">
                    <span>Subtotal</span>
                    <span id="cart-total">$0.00</span>
                </div>
                <button onclick="openCheckout()" id="btn-checkout" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Proceed to Checkout
                </button>
            </div>
        </div>
    </div>

    <!-- CHECKOUT MODAL -->
    <div id="checkout-modal" class="fixed inset-0 z-[60] bg-black bg-opacity-70 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden fade-in">
            <div class="bg-orange-600 text-white p-4 flex justify-between items-center">
                <h3 class="font-bold text-lg">Checkout Details</h3>
                <button onclick="closeCheckout()" class="text-white hover:text-orange-200"><i class="fas fa-times"></i></button>
            </div>
            <form id="checkout-form" class="p-6 space-y-4">
                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded text-sm text-yellow-800 mb-4">
                    <i class="fas fa-info-circle mr-1"></i> We will call your number to confirm this order.
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                    <input type="text" id="cust-name" class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-orange-500 outline-none" placeholder="Juan Dela Cruz" required>
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Delivery Address</label>
                    <textarea id="cust-address" class="w-full border-2 border-gray-200 rounded-lg p-3 focus:border-orange-500 outline-none h-20" placeholder="House No, Street, Barangay..." required></textarea>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mobile Number</label>
                    <div class="flex">
                        <span class="bg-gray-100 border-2 border-r-0 border-gray-200 rounded-l-lg p-3 text-gray-500 font-bold">+63</span>
                        <input type="tel" id="cust-phone" class="w-full border-2 border-gray-200 rounded-r-lg p-3 focus:border-orange-500 outline-none" placeholder="912 345 6789" required pattern="[0-9]{10}">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Payment Method</label>
                    <div class="grid grid-cols-2 gap-4">
                        <label class="cursor-pointer">
                            <input type="radio" name="payment" value="COD" class="peer sr-only" checked>
                            <div class="border-2 rounded-xl p-4 text-center hover:bg-gray-50 peer-checked:border-orange-600 peer-checked:bg-orange-50 peer-checked:text-orange-700 transition">
                                <i class="fas fa-money-bill-wave text-2xl mb-1"></i>
                                <div class="font-bold text-sm">Cash on Delivery</div>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="payment" value="GCash" class="peer sr-only">
                            <div class="border-2 rounded-xl p-4 text-center hover:bg-gray-50 peer-checked:border-blue-600 peer-checked:bg-blue-50 peer-checked:text-blue-700 transition">
                                <i class="fas fa-mobile-alt text-2xl mb-1"></i>
                                <div class="font-bold text-sm">GCash on Delivery</div>
                            </div>
                        </label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg mt-4 transition transform active:scale-95">
                    Place Order - <span id="checkout-btn-total">$0.00</span>
                </button>
            </form>
        </div>
    </div>

    <!-- SUCCESS MODAL -->
    <div id="success-modal" class="fixed inset-0 z-[70] bg-black bg-opacity-80 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-2xl p-8 text-center fade-in">
            <div class="w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center text-4xl mx-auto mb-4">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Order Placed!</h2>
            <p class="text-gray-600 mb-6">Thank you, <span id="success-name" class="font-bold"></span>! We have received your order. Please keep your phone ready for our confirmation call.</p>
            <button onclick="location.reload()" class="bg-orange-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-orange-700 w-full">Back to Home</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, runTransaction, query, where, orderBy, getDocs, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB5L9S3_diMaKQ7IyXEnyhEuWOHz8-QTvY",
            authDomain: "my-pos-system-3683a.firebaseapp.com",
            projectId: "my-pos-system-3683a",
            storageBucket: "my-pos-system-3683a.firebasestorage.app",
            messagingSenderId: "1040426979758",
            appId: "1:1040426979758:web:da01b11782d68dac86f83f",
            measurementId: "G-19J5SSFD9H"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // State
        let inventory = [];
        let cart = {}; // { itemId: { quantity: 1, item: {...} } }
        let currentFilter = 'All';

        // --- INIT ---
        // Fetch Inventory
        const q = query(collection(db, "inventory"), orderBy("name"));
        onSnapshot(q, (snapshot) => {
            inventory = [];
            snapshot.forEach(doc => {
                const data = doc.data();
                if(data.stock > 0) { // Only show items in stock
                    inventory.push({ id: doc.id, ...data });
                }
            });
            renderGrid();
        });

        // --- RENDER ---
        window.filter = (cat) => {
            currentFilter = cat;
            renderGrid();
            // Update pills
            document.querySelectorAll('.cat-btn').forEach(btn => {
                if(btn.innerText === cat || (cat === 'All' && btn.innerText === 'All')) {
                    btn.className = "cat-btn px-6 py-2 bg-orange-900 text-white rounded-full font-bold shadow-lg transform scale-105 whitespace-nowrap transition";
                } else {
                    btn.className = "cat-btn px-6 py-2 bg-white text-gray-700 rounded-full font-bold shadow hover:bg-orange-100 whitespace-nowrap transition";
                }
            });
        };

        function renderGrid() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            
            const filtered = inventory.filter(i => currentFilter === 'All' || i.category === currentFilter);

            if(filtered.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-400">No items available in this category.</div>';
                return;
            }

            filtered.forEach(item => {
                const card = document.createElement('div');
                card.className = "bg-white rounded-2xl shadow-md hover:shadow-xl transition overflow-hidden flex flex-col h-full border border-gray-100";
                card.innerHTML = `
                    <div class="h-40 bg-orange-100 flex items-center justify-center text-orange-300">
                        <i class="fas fa-utensils text-4xl"></i>
                    </div>
                    <div class="p-5 flex-1 flex flex-col">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-lg text-gray-800 leading-tight">${item.name}</h3>
                            <span class="text-xs font-bold bg-green-100 text-green-700 px-2 py-1 rounded-full">${item.stock} left</span>
                        </div>
                        <p class="text-sm text-gray-500 mb-4 line-clamp-2">${item.category}</p>
                        <div class="mt-auto flex justify-between items-center">
                            <span class="text-xl font-bold text-orange-600">$${item.price.toFixed(2)}</span>
                            <button onclick="addToCart('${item.id}')" class="bg-gray-900 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-orange-600 transition shadow-lg">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- CART LOGIC ---
        window.addToCart = (id) => {
            const item = inventory.find(i => i.id === id);
            if(!item) return;

            if(cart[id]) {
                if(cart[id].quantity < item.stock) {
                    cart[id].quantity++;
                } else {
                    alert("Max stock reached for this item.");
                    return;
                }
            } else {
                cart[id] = { quantity: 1, item: item };
            }
            
            // Animation for badge
            const badge = document.getElementById('cart-badge');
            badge.classList.add('cart-bounce');
            setTimeout(() => badge.classList.remove('cart-bounce'), 500);
            
            renderCart();
        };

        window.updateQty = (id, delta) => {
            if(!cart[id]) return;
            const newQty = cart[id].quantity + delta;
            
            if(newQty <= 0) {
                delete cart[id];
            } else if(newQty <= cart[id].item.stock) {
                cart[id].quantity = newQty;
            } else {
                alert("Max stock reached.");
            }
            renderCart();
        };

        function renderCart() {
            const items = Object.values(cart);
            const count = items.reduce((sum, i) => sum + i.quantity, 0);
            const total = items.reduce((sum, i) => sum + (i.quantity * i.item.price), 0);

            // Badge
            const badge = document.getElementById('cart-badge');
            badge.textContent = count;
            badge.classList.toggle('hidden', count === 0);
            badge.classList.toggle('scale-100', count > 0);
            badge.classList.toggle('scale-0', count === 0);

            // Modal List
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            
            if(items.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 mt-20 flex flex-col items-center">
                        <i class="fas fa-shopping-basket text-6xl mb-4 opacity-20"></i>
                        <p>Your bag is empty.</p>
                        <button onclick="toggleCart()" class="mt-4 text-orange-600 font-bold hover:underline">Start Ordering</button>
                    </div>`;
                document.getElementById('btn-checkout').disabled = true;
            } else {
                items.forEach(i => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center bg-white border rounded-xl p-3 shadow-sm";
                    div.innerHTML = `
                        <div class="flex-1">
                            <h4 class="font-bold text-gray-800">${i.item.name}</h4>
                            <p class="text-sm text-gray-500">$${i.item.price} x ${i.quantity}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="updateQty('${i.item.id}', -1)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 font-bold">-</button>
                            <span class="font-bold w-4 text-center">${i.quantity}</span>
                            <button onclick="updateQty('${i.item.id}', 1)" class="w-8 h-8 rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200 font-bold">+</button>
                        </div>
                    `;
                    container.appendChild(div);
                });
                document.getElementById('btn-checkout').disabled = false;
            }

            // Totals
            const totalStr = '$' + total.toFixed(2);
            document.getElementById('cart-total').textContent = totalStr;
            document.getElementById('checkout-btn-total').textContent = totalStr;
        }

        window.toggleCart = () => {
            const modal = document.getElementById('cart-modal');
            const panel = document.getElementById('cart-panel');
            
            if(modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => panel.classList.remove('translate-x-full'), 10); // Slide in
            } else {
                panel.classList.add('translate-x-full'); // Slide out
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        };

        // --- CHECKOUT ---
        window.openCheckout = () => {
            toggleCart(); // Close cart
            document.getElementById('checkout-modal').classList.remove('hidden');
        };

        window.closeCheckout = () => {
            document.getElementById('checkout-modal').classList.add('hidden');
        };

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            btn.disabled = true;

            const name = document.getElementById('cust-name').value;
            const addr = document.getElementById('cust-address').value;
            const phone = document.getElementById('cust-phone').value;
            const payment = document.querySelector('input[name="payment"]:checked').value;
            const items = Object.values(cart);

            try {
                await runTransaction(db, async (t) => {
                    // 1. Read & Validate Stock again
                    const itemReads = [];
                    for(const i of items) {
                        const ref = doc(db, "inventory", i.item.id);
                        const snap = await t.get(ref);
                        if(!snap.exists()) throw `Item ${i.item.name} is no longer available.`;
                        if(snap.data().stock < i.quantity) throw `Not enough stock for ${i.item.name}.`;
                        itemReads.push({ ref, snap, item: i });
                    }

                    // 2. Write Stock
                    for(const r of itemReads) {
                        t.update(r.ref, { 
                            stock: r.snap.data().stock - r.item.quantity,
                            lastSold: new Date().toISOString()
                        });
                    }

                    // 3. Create Order
                    const total = items.reduce((sum, i) => sum + (i.quantity * i.item.price), 0);
                    const orderRef = doc(collection(db, "active_orders"));
                    
                    t.set(orderRef, {
                        tableName: `Online: ${name}`, // Shows in POS
                        tableId: 'online', // Mark as online
                        status: 'pending',
                        items: items.map(i => ({
                            name: i.item.name,
                            qty: i.quantity,
                            price: i.item.price,
                            id: i.item.id,
                            discount: 0
                        })),
                        total: total,
                        timestamp: new Date().toISOString(),
                        staffEmail: 'Online Order',
                        customerDetails: {
                            name: name,
                            address: addr,
                            phone: '+63' + phone,
                            paymentMethod: payment
                        }
                    });
                });

                // Success
                cart = {};
                renderCart();
                closeCheckout();
                document.getElementById('success-name').textContent = name;
                document.getElementById('success-modal').classList.remove('hidden');

            } catch (err) {
                alert("Order Failed: " + (typeof err === 'string' ? err : err.message));
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

    </script>
</body>
</html>
